<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Shot Timer ++</title>
  <link rel="stylesheet" href="style.css">
  <link rel="apple-touch-icon" sizes="180x180" href="app-logo.png">
</head>
<body>
  <button id="resetCourseBtn" class="top-new btn-primary">Reset Course</button>
  <button id="themeBtn" class="top-theme-btn btn-primary" aria-pressed="false" title="Toggle dark mode">üåô</button>
  <label class="top-theme" style="margin-left:0.5rem; display:none;">
    <input type="checkbox" id="themeToggle"> Dark mode
  </label>

  <!-- Heading block: ensures logo is centered directly above the heading -->
  <div class="heading-wrap">
    <div class="logo-wrap">
      <!-- Inline SVG so it can be colored using CSS (uses currentColor) -->
      <svg class="logo svg-logo" role="img" aria-label="Shot Timer" viewBox="0 0 496 496" xmlns="http://www.w3.org/2000/svg">
        <title>Shot Timer</title>
        <desc>Logo for Shot Timer ++</desc>
        <path fill="currentColor" d="M207.000000,1.000000 C234.687561,1.000000 262.375122,1.000000 290.742432,1.256965 C297.885040,5.758818 302.160156,11.159070 299.986725,19.417984 C297.718353,28.037605 291.060852,30.319490 283.118988,30.430244 C279.645996,30.478678 278.503357,32.569592 278.483612,35.641479 C278.452545,40.472927 278.540039,45.306717 278.418518,50.135517 C278.314423,54.271553 279.932068,56.468132 284.222717,57.350979 C293.174194,59.192852 302.143250,61.129272 310.891510,63.742046 C330.443176,69.581367 348.752319,78.287323 365.983521,89.192917 C370.138977,91.822906 373.260742,91.149467 376.526672,87.785561 C382.443817,81.690788 388.816315,76.019714 394.490906,69.714729 C397.892120,65.935707 400.120300,66.382149 403.362823,69.678391 C417.382080,83.929886 431.479797,98.107155 445.748901,112.107704 C449.009857,115.307327 448.565826,117.318375 445.524475,120.213310 C438.890137,126.528358 432.714325,133.329895 426.002197,139.556488 C422.410706,142.888153 422.559631,145.555328 425.121338,149.397018 C445.094055,179.349594 456.155334,212.437943 459.466187,248.210358 C460.633942,260.827637 460.687653,260.867615 472.921783,261.567657 C476.124908,261.750946 478.759094,262.981903 479.086700,266.173431 C479.446747,269.680542 476.781647,271.442444 473.599457,272.194702 C469.476807,273.169189 464.523315,271.238159 461.221130,274.700195 C457.985687,278.092255 460.311035,283.153351 458.664490,287.183990 C458.541748,287.484467 458.520020,287.835083 458.495789,288.165649 C456.709045,312.562042 449.588745,335.560516 438.965485,357.356750 C418.237244,399.885712 386.505188,431.990448 344.397308,453.511841 C318.654968,466.668762 291.196167,474.093567 262.212250,475.454315 C255.849350,475.753052 254.529739,477.211639 254.466492,483.748962 C254.423370,488.207520 255.164413,492.769958 253.000000,497.000000 C250.299988,497.000000 247.599976,497.000000 244.442688,496.611176 C243.801926,491.399719 243.643051,486.575958 243.427505,481.754761 C243.241074,477.584656 241.258926,475.222961 236.840576,475.397949 C229.820648,475.675934 222.939453,474.432190 216.051086,473.391510 C190.416794,469.518738 166.465759,460.906586 144.029892,447.917572 C121.603683,434.934235 102.155838,418.561127 85.826981,398.386505 C67.351326,375.559418 53.822475,350.246216 46.077641,321.875275 C42.656143,309.341614 40.482315,296.606598 39.308743,283.672363 C38.428268,273.968414 36.594902,272.368286 27.351162,272.445129 C26.184690,272.454834 25.005507,272.577057 23.854191,272.449188 C20.837967,272.114258 18.803673,270.422852 18.652800,267.376251 C18.489061,264.069794 20.480356,262.103058 23.715321,261.675049 C25.518726,261.436401 27.375654,261.604309 29.208422,261.585144 C36.149845,261.512451 37.665264,260.102173 38.516197,253.350647 C39.842602,242.826630 40.552635,232.159943 42.792370,221.828735 C48.485081,195.570023 58.621880,171.033066 73.602592,148.630402 C75.885780,145.216049 75.548492,142.807404 72.595490,139.977692 C65.016235,132.714951 57.690163,125.188179 50.253094,117.776779 C44.952850,112.494820 44.959156,112.515167 50.397072,107.018845 C63.965935,93.304268 77.533653,79.588501 91.075043,65.846809 C95.287178,61.572372 95.873764,61.715702 100.012840,66.024261 C107.398613,73.712433 115.074089,81.121643 122.502243,88.770042 C125.667770,92.029434 128.631577,91.868370 132.221817,89.476418 C136.927490,86.341301 141.751312,83.339523 146.733658,80.671310 C168.025314,69.268867 190.515442,61.254189 214.401459,57.370502 C218.600037,56.687843 220.478806,54.304436 220.518158,50.224194 C220.553528,46.557987 220.568924,42.891415 220.565094,39.225033 C220.556335,30.857803 220.549347,30.857809 212.190521,30.389706 C203.934158,29.927340 199.000824,24.343050 198.423401,16.281746 C197.899368,8.965708 202.125900,4.952477 207.000000,1.000000 M197.438339,418.899750 C209.718811,423.240417 222.395416,425.698334 235.338272,426.917358 C241.252640,427.474365 242.866043,426.338989 243.058823,420.807617 C243.331528,412.982697 243.510712,405.150513 243.514236,397.321320 C243.517426,390.193573 241.810776,388.610382 234.926346,387.659851 C229.344833,386.889191 223.739288,386.018372 218.286484,384.632812 C169.867554,372.329651 132.899582,329.566162 128.488602,280.608551 C128.119156,276.508087 126.638618,272.561340 121.401756,272.503632 C112.570358,272.406219 103.735596,272.371429 94.905396,272.510193 C90.564323,272.578400 88.694336,275.393982 88.766273,279.451721 C88.816017,282.257507 89.128578,285.083191 89.599625,287.853027 C92.828995,306.842346 98.166985,325.128967 107.422325,342.167786 C127.455757,379.048828 157.205856,404.523529 197.438339,418.899750 M307.160095,373.751038 C292.942596,381.341583 278.007355,386.530853 261.799377,387.761566 C257.931976,388.055206 254.595856,389.688263 254.580246,394.456390 C254.550293,403.618164 254.532822,412.780182 254.563309,421.941925 C254.576752,425.979614 256.985260,427.770172 260.703705,427.382507 C270.944397,426.314789 281.173462,424.713409 291.036163,421.902466 C324.494690,412.366516 352.548920,394.208771 374.256836,366.944641 C394.440033,341.595551 406.332336,312.720428 408.706451,280.194672 C409.099884,274.804749 407.320831,272.620483 402.049957,272.510284 C393.890717,272.339722 385.720062,272.388733 377.561859,272.616180 C372.435516,272.759155 369.746399,275.293854 369.476624,280.321960 C368.695923,294.871674 364.132935,308.313477 357.754791,321.210876 C346.578491,343.810730 329.755432,361.071136 307.160095,373.751038 M190.173004,117.747536 C160.585464,129.532089 136.627365,148.583817 118.150139,174.387680 C101.122337,198.167389 91.604988,224.869049 88.710747,253.953766 C88.252731,258.556427 89.888847,260.860779 94.702370,261.214294 C103.347572,261.849152 112.008545,261.689880 120.668098,261.153748 C125.604637,260.848114 127.631226,257.784302 128.444061,253.505859 C128.751129,251.889572 128.399399,250.151230 128.682312,248.526764 C135.368683,210.133530 155.497574,180.898697 188.995499,161.084656 C202.897400,152.861694 218.153351,148.206741 234.224533,146.361115 C238.726028,145.844177 242.631836,144.262466 243.089096,139.198776 C243.913406,130.070358 243.954086,120.893005 242.990311,111.763397 C242.591034,107.981071 239.935867,106.146133 236.294998,106.598038 C220.764984,108.525658 205.520905,111.735237 190.173004,117.747536 M384.041962,180.412460 C376.470581,168.322006 366.936493,157.888657 356.596527,148.167221 C342.720337,135.121078 326.703064,125.355721 309.089569,118.307167 C294.538544,112.484146 279.534363,108.417236 263.742950,107.307831 C255.979126,106.762390 254.042511,107.822052 254.583099,115.608284 C255.069672,122.616425 254.593689,129.597733 254.499725,136.591888 C254.413040,143.044388 256.337555,145.467331 262.789551,146.067154 C268.123810,146.563034 273.343353,147.632690 278.458893,148.943375 C310.610413,157.181305 335.613922,175.545181 352.909943,203.748611 C362.178558,218.862366 368.672943,235.269226 369.482056,253.407181 C369.735077,259.078400 371.825256,261.254700 377.528839,261.409973 C383.684113,261.577515 389.852020,261.257721 396.014801,261.178284 C409.278534,261.007294 410.307922,259.816010 408.481598,246.656647 C408.458710,246.491913 408.422150,246.329102 408.395233,246.164871 C404.587158,222.912888 397.149292,200.994812 384.041962,180.412460 M203.544327,272.662750 C194.396606,272.591003 185.247574,272.395996 176.101685,272.494568 C170.751434,272.552216 169.216232,274.890869 170.214569,280.189056 C173.622025,298.272369 181.774933,313.658813 195.620377,325.980865 C207.337982,336.409180 220.581070,343.444336 236.292511,345.567993 C240.560272,346.144836 242.808395,344.593964 242.925156,340.406250 C243.175461,331.428741 243.804733,322.453278 243.179047,313.462402 C242.918350,309.716431 241.359482,307.410309 237.520859,306.301636 C223.293488,302.192413 214.284149,292.617432 209.766510,278.721008 C208.807434,275.770874 207.441666,273.623077 203.544327,272.662750 M196.324371,261.524994 C198.483841,261.400909 200.641922,261.217407 202.803116,261.166382 C206.228409,261.085510 208.330261,259.511932 209.359421,256.167969 C213.964737,241.204086 223.718170,231.386566 238.850082,227.074554 C241.387802,226.351395 242.937378,224.870255 242.981216,222.156708 C243.131668,212.844498 243.492828,203.525620 243.270111,194.221359 C243.143311,188.924835 241.003235,187.467056 235.833328,188.320450 C217.224731,191.392090 201.885208,200.342682 189.324310,214.313873 C179.155273,225.624649 172.751282,238.715210 170.439468,253.740463 C169.539932,259.586823 170.672546,261.080231 176.483795,261.365021 C182.789948,261.674103 189.120056,261.494385 196.324371,261.524994 M254.861130,314.748962 C254.734863,322.078827 254.557983,329.408234 254.495239,336.738647 C254.418381,345.719788 256.116302,347.076569 264.852448,345.211304 C265.502716,345.072449 266.129272,344.823395 266.778961,344.680817 C283.844482,340.935608 297.690582,331.848206 309.222626,318.989441 C318.911438,308.186005 324.985992,295.558197 327.375305,281.275360 C328.584534,274.046967 326.959198,272.430573 319.407379,272.457581 C312.576874,272.481964 305.747742,272.773346 298.916901,272.853271 C290.651367,272.949982 290.489319,272.849213 287.730194,280.526581 C282.988068,293.721680 273.807983,302.198456 260.590424,306.290588 C256.568329,307.535797 254.739822,309.776733 254.861130,314.748962 M293.968719,260.996246 C302.781067,261.037048 311.593842,261.150513 320.405579,261.095428 C327.288910,261.052399 328.457520,259.521973 327.409607,252.508102 C322.706390,221.028656 292.863525,192.031479 261.344513,188.315201 C256.729614,187.771057 254.599747,189.391464 254.537964,193.928741 C254.420288,202.571304 254.511353,211.216568 254.484604,219.860611 C254.472412,223.800537 255.919800,226.164825 260.084564,227.424240 C274.049011,231.647034 283.582794,240.644226 288.079193,254.743500 C288.916321,257.368591 289.620270,260.355835 293.968719,260.996246 z"/>
      </svg>
    </div>
    <h1>Shot Timer ++</h1>
  </div>

  <!-- -------------------------------------------------------------
       Big countdown display
       ------------------------------------------------------------- -->
  <div id="display">00:00.0</div>

  <!-- collapsed setup area (toggle shows full controls) -->

  <!-- -------------------------------------------------------------
       Course chooser (loads data/courses/*.json)
       ------------------------------------------------------------- -->
  <!-- Collapsible area: hide setup, course chooser, RMS, and device selectors by default -->
  <button id="collapseToggle" class="collapse-toggle" aria-expanded="false" aria-controls="collapsedArea">Show setup ‚ñ∏</button>
  <div id="collapsedArea" class="collapsed hidden">
    <section id="setup">
      <label>
        Total time (seconds):
        <input type="number"
          id="totalSecInput" size="6"
          title="Total countdown time in seconds for the stage. Must be a positive integer."
          min="1"
          value="5"
          step="1"
          inputmode="numeric"
          pattern="\d*">
      </label>

      <label>
        Expected shots:
        <input type="number"
          id="shotsCountInput" size="6"
          title="Expected number of shots for the stage. Used for display and scoring."
          min="1"
          value="3"
          step="1"
          inputmode="numeric"
          pattern="\d*">
      </label>

      <label>
        Shot‚Äëdetect threshold (RMS 0‚Äë127):
        <input type="range"
               id="thresholdInput"
               title="Shot detection sensitivity. Higher values make detection less sensitive. Use Listen to observe RMS and choose a value below your clap peaks but above background noise."
               min="0"
               max="127"
               value="30">
        <span id="thresholdValue">30</span>
      </label>
  <p id="thresholdHelp" class="input-hint"><span class="info-icon" role="img" aria-label="Info">‚ÑπÔ∏è</span> Click "Detect Devices" then "Listen" and clap near the mic. Note the RMS value shown, then set the threshold a little below your clap peak but above the ambient noise level.</p>

      <label>
        Debounce (ms) ‚Äì ignore repeats within this window:
        <input type="range"
          id="debounceInput"
          title="Debounce window in milliseconds. Repeated detections within this time are ignored to prevent duplicates from a single event."
          min="0"
          max="1000"
          step="50"
          value="100">
        <span id="debounceValue">100</span>
      </label>
      <label>
        <input type="checkbox" id="beepOnShot">
        Beep on detection
      </label>
      <label>
        <input type="checkbox" id="showRmsColumn">
        Show RMS column
      </label>
      <label>
        UI zoom:
        <div class="ui-zoom-control" aria-live="polite">
          <button type="button" id="uiZoomMinus" class="btn-primary" aria-label="Decrease UI zoom">‚àí</button>
          <span id="uiZoomValue">100%</span>
          <button type="button" id="uiZoomPlus" class="btn-primary" aria-label="Increase UI zoom">+</button>
        </div>
      </label>
    </section>

    <section id="courseChooser">
      <div class="chooser-fields">
        <div class="chooser-row">
          <label class="chooser-label">
            Course:
            <select id="courseSelect">
              <option value="">(select a course)</option>
            </select>
          </label>
          <!-- lightweight course notes area (populated by courseChooser.js) -->
          <div id="courseNotes" class="course-notes input-hint">Select a course to see course notes.</div>
        </div>

        <div class="chooser-row">
          <label class="chooser-label">
            Stage:
            <select id="stageSelect">
              <option value="">(select a stage)</option>
            </select>
          </label>
        </div>
      </div>
    </section>

    <!-- Live RMS meter (read‚Äëonly, just for visual feedback) -->
    <section id="rmsSection">
      <label>
        Mic level (RMS):
        <input type="range"
               id="rmsMeter"
               min="0"
               max="127"
               value="0"
               disabled>
        <span id="rmsValue">0.00</span>
      </label>
  <p id="rmsTip" class="input-hint"><span class="info-icon" role="img" aria-label="Info">‚ÑπÔ∏è</span> "RMS" (root mean square) is a short-term measure of signal energy ‚Äî higher RMS means louder sound. The meter shows RMS; in decibels (dBFS) that's 20 &middot; log10(RMS) when samples are normalized (RMS = 1.0 &rarr; 0&nbsp;dBFS). Converting to real acoustic dB SPL requires microphone calibration.</p>
    </section>

    <!-- Device selectors (filled by controls.js) -->
    <section id="devices">
      <label id="micLabel">
        Mic:
        <select id="micSelect"></select>
      </label>

      <label>
        Speaker:
        <select id="speakerSelect"></select>
      </label>
    </section>

    <!-- Show setup checkbox removed: setup buttons will be visible when collapsed area is expanded -->
  </div>

  <!-- Next stage button sits above the main control buttons on its own row -->
  <!-- Next Stage button moved into the main buttons group for responsive layout -->

  <!-- -------------------------------------------------------------
       Control buttons
       ------------------------------------------------------------- -->
  <div class="buttons">
    <div class="left-controls">
      <button id="detectBtn" class="btn-primary">Detect Devices</button>
      <button id="listenBtn">Listen</button>
      <button id="calibrateBtn" class="btn-primary">Calibrate Latency</button>
    </div>

    <div class="action-group">
  <button id="startBtn" class="btn-primary btn-equal">Start</button>
  <button id="nextStageBtn" class="btn-primary next-btn btn-equal">Next</button>
    </div>

    <div class="right-controls" aria-hidden="true"></div>
  </div>

  <!-- Current stage instructions (large, prominent) ‚Äî moved below the controls per request -->
  <section id="stageInstructions" aria-live="polite">
    <div class="stage-instructions-inner">
      <h2 id="stageTitle">No stage selected</h2>
      <div id="stageMeta" class="stage-meta">&nbsp;</div>
      <div id="stageRounds" class="stage-rounds">&nbsp;</div>
      <div id="stageDetails">Select a course to see instructions here.</div>
    </div>
  </section>

  <!-- Small status area for permission / device messages -->
  <div id="status" role="status" aria-live="polite" class="status"></div>
  <!-- -------------------------------------------------------------
       Shots‚Äëdetected panel (populated by shotsTable.js)
       ------------------------------------------------------------- -->
  <section id="shotsPanel">
    <h2>Shots detected: <span id="shotsSummaryCount">0</span></h2>
    <table id="shotsTable">
      <thead>
        <tr>
          <th>Stage</th>
          <th>Time</th>
          <th title="Delta between this shot and the previous shot (ms)">Œî (ms)</th>
          <th>RMS</th>
        </tr>
      </thead>
      <tbody><!-- rows inserted by JS --></tbody>
    </table>
  </section>

  <!-- -------------------------------------------------------------
       Entry‚Äëpoint script (ES‚Äëmodule)
       ------------------------------------------------------------- -->
  <script>
    // Collapse toggle behaviour ‚Äî shows/hides the setup/course/devices area
    (function () {
      const btn = document.getElementById('collapseToggle');
      const area = document.getElementById('collapsedArea');
      if (!btn || !area) return;
      btn.addEventListener('click', () => {
        const expanded = btn.getAttribute('aria-expanded') === 'true';
        if (expanded) {
          area.classList.add('collapsed'); area.classList.add('hidden');
          btn.setAttribute('aria-expanded', 'false'); btn.textContent = 'Show setup ‚ñ∏';
        } else {
          area.classList.remove('collapsed'); area.classList.remove('hidden');
          btn.setAttribute('aria-expanded', 'true'); btn.textContent = 'Hide setup ‚ñæ';
        }
      });
    }());
  </script>
  <!-- Lightweight theme initializer: ensures theme toggle works even if module JS hasn't run yet -->
  <script>
    (function () {
      const THEME_KEY = 'shot-timer-theme';
      const cb = document.getElementById('themeToggle');
      const btn = document.getElementById('themeBtn');
      function applyTheme(t) {
        if (t === 'dark') {
          document.documentElement.setAttribute('data-theme', 'dark');
          if (btn) {
            btn.setAttribute('aria-pressed', 'true');
            btn.textContent = '‚òÄÔ∏è'; /* show sun in dark mode to indicate clicking will be bright */
          }
        } else {
          document.documentElement.removeAttribute('data-theme');
          if (btn) {
            btn.setAttribute('aria-pressed', 'false');
            btn.textContent = 'üåô';
          }
        }
        if (cb) cb.checked = (t === 'dark');
      }
      try {
        const stored = localStorage.getItem(THEME_KEY);
        if (stored) applyTheme(stored);
        else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) applyTheme('dark');
      } catch (e) { /* ignore storage errors */ }
      if (cb) cb.addEventListener('change', function (ev) {
        const t = ev.target.checked ? 'dark' : 'light';
        try { localStorage.setItem(THEME_KEY, t); } catch (e) {}
        applyTheme(t);
      });
      if (btn) btn.addEventListener('click', function () {
        const cur = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
        const next = cur === 'dark' ? 'light' : 'dark';
        try { localStorage.setItem(THEME_KEY, next); } catch (e) {}
        applyTheme(next);
      });
    }());
  </script>
  <script type="module" src="./js/main.js"></script>
  <footer id="siteFooter" class="site-footer" aria-label="Site footer">
    <div class="site-footer-inner">
      <small>¬© <span id="copyrightYear">2025</span> Rob Morrison ‚Äî Shot Timer ++</small>
    </div>
  </footer>
  <script>
    (function () {
      try {
        const y = new Date().getFullYear();
        const el = document.getElementById('copyrightYear');
        if (el) el.textContent = String(y);
      } catch (e) { /* ignore */ }
    }());
  </script>
</body>
</html>
