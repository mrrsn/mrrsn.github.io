import{setTotalSeconds,setExpectedShots,setThreshold,setDebounceMs,setBeepOnShot,getBeepOnShot}from"../timer/config.js";import{resetTimer,stopTimer,incrementStageAttempt,setStageContext}from"../timer/core.js";import{setOutputDevice,getAudioContext,supportsSetSinkId,ensureAudioRunning}from"../audio/context.js";import{pollDetector,setListenMode,stopMic,initMic}from"../audio/detector.js";import{setRmsColumnVisible}from"./shotsTable.js";import{playBeep}from"../audio/beep.js";import{formatTime}from"../timer/utils.js";const $=t=>document.querySelector(t);function getEl(t){try{return document.getElementById(t)}catch(t){return null}}let __populateDevicesInProgress=!1,__isListening=!1,__deviceChangeHandlerAdded=!1,__autoDeviceAllowed=!1,statusClearTimer=null;function setStatus(t,e=""){const n=document.getElementById("status");if(!n)return;try{if(n.dataset&&"1"===n.dataset.manuallyClosed&&"error"!==e)return}catch(t){}n.classList.remove("hidden","error","success"),n.classList.add("status-visible"),"error"===e&&n.classList.add("error"),"success"===e&&n.classList.add("success");let a=n.querySelector(".status-message");a||(a=document.createElement("span"),a.className="status-message",n.insertBefore(a,n.firstChild)),a.textContent=t;let c=n.querySelector(".status-controls");c||(c=document.createElement("div"),c.className="status-controls",c.style.marginTop="0.25rem",n.appendChild(c))}function clearStatus(){const t=document.getElementById("status");if(t){t.classList.add("hidden"),t.classList.remove("status-visible","error","success"),statusClearTimer&&(clearTimeout(statusClearTimer),statusClearTimer=null);try{const e=t.querySelector(".status-message");e&&e.remove();const n=t.querySelector(".status-controls");n&&n.remove();const a=t.querySelector(".status-details");a&&a.remove()}catch(t){}}}function scheduleClear(t){try{statusClearTimer&&(clearTimeout(statusClearTimer),statusClearTimer=null),statusClearTimer=setTimeout(()=>{try{clearStatus()}catch(t){}finally{statusClearTimer=null}},t)}catch(t){}}function buildDeviceDiagnostics(t,e){const n=t.filter(t=>"audioinput"===t.kind),a=t.filter(t=>"audiooutput"===t.kind),c=n.some(t=>!t.label||""===t.label.trim());return{when:(new Date).toISOString(),ua:navigator.userAgent||"",permission:e||"unknown",sinkSupported:"function"==typeof HTMLAudioElement.prototype.setSinkId,counts:{mics:n.length,speakers:a.length},devices:t.map(t=>({kind:t.kind,label:t.label||"(hidden)",id:(t.deviceId||"").slice(0,8)})),labelHidden:c}}function showStatusWithDetails(t,e,n,a){try{setStatus(t,e);const c=document.getElementById("status");if(!c)return;const s=c.querySelector(".status-details");s&&s.remove();const o=document.createElement("div");o.className="status-details",o.style.marginTop="0.5rem";const i=document.createElement("button");if(i.type="button",i.className="btn-secondary",i.textContent="Details",i.style.marginRight="0.5rem",o.appendChild(i),"function"==typeof a){const t=document.createElement("button");t.type="button",t.className="btn-secondary",t.textContent="Retry",t.style.marginRight="0.5rem",t.addEventListener("click",()=>{try{a()}catch(t){console.warn("Retry failed",t)}}),o.appendChild(t)}const r=document.createElement("button");r.type="button",r.className="btn-secondary",r.textContent="Close",r.style.marginLeft="0.25rem",r.addEventListener("click",()=>{try{const t=document.getElementById("status");if(t)try{t.dataset.manuallyClosed="1"}catch(t){}clearStatus()}catch(t){console.warn("Close failed",t)}}),o.appendChild(r);const l=document.createElement("button");l.type="button",l.className="btn-secondary",l.textContent="Copy diagnostics",l.style.marginRight="0.5rem",o.appendChild(l);const d=document.createElement("pre");d.style.display="none",d.style.maxHeight="200px",d.style.overflow="auto",d.style.marginTop="0.5rem",d.style.background="rgba(0,0,0,0.03)",d.style.padding="0.5rem",d.textContent=n?JSON.stringify(n,null,2):"{}",o.appendChild(d);let u=c.querySelector(".status-controls");u||(u=document.createElement("div"),u.className="status-controls",u.style.marginTop="0.25rem",c.appendChild(u)),u.appendChild(o);let m=!1;i.addEventListener("click",()=>{m=!m,d.style.display=m?"":"none",i.textContent=m?"Hide details":"Details";try{m&&statusClearTimer&&(clearTimeout(statusClearTimer),statusClearTimer=null)}catch(t){}}),l.addEventListener("click",async()=>{try{if(navigator.clipboard&&navigator.clipboard.writeText)await navigator.clipboard.writeText(d.textContent),setStatus("Diagnostics copied to clipboard","success"),scheduleClear(1500);else{const t=document.createElement("textarea");t.value=d.textContent,document.body.appendChild(t),t.select(),document.execCommand("copy"),t.remove(),setStatus("Diagnostics copied to clipboard","success"),scheduleClear(1500)}}catch(t){console.warn("Copy diagnostics failed",t),setStatus("Failed to copy diagnostics","error"),scheduleClear(2e3)}});try{"function"!=typeof a&&scheduleClear(3e3)}catch(t){}}catch(t){console.warn("showStatusWithDetails failed",t)}}function transientPress(t,e=250){if(t)try{t.classList.add("pressed"),setTimeout(()=>{try{t.classList.remove("pressed")}catch(t){}},e)}catch(t){}}function sanitizeNumericInput(t,{allowDecimal:e=!1,allowNegative:n=!1,maxLength:a=null}={}){if(!t)return;const c=t=>{let c=String(t||"");if(c=c.replace(/\s+/g,""),e){c=c.replace(/[^0-9.\-]/g,"");const t=c.split(".");t.length>1&&(c=t.shift()+"."+t.join(""))}else c=c.replace(/[^0-9\-]/g,"");return n||(c=c.replace(/-/g,"")),a&&c.length>a&&(c=c.slice(0,a)),c};t.addEventListener("input",e=>{try{const e=t.value,n=c(e);if(n!==e){const e=t.selectionStart||0;t.value=n;try{t.setSelectionRange(Math.max(0,e-1),Math.max(0,e-1))}catch(t){}}}catch(t){}}),t.addEventListener("paste",e=>{try{e.preventDefault();const n=e.clipboardData&&e.clipboardData.getData?e.clipboardData.getData("text"):window.clipboardData?window.clipboardData.getData("Text"):"",a=c(n),s=t.selectionStart||0,o=t.selectionEnd||0,i=t.value.slice(0,s),r=t.value.slice(o);t.value=i+a+r;try{t.dispatchEvent(new Event("input",{bubbles:!0}))}catch(t){}}catch(t){}}),t.addEventListener("keydown",a=>{try{const c=a.key;if(1!==c.length)return;if(!(e?/[0-9.\-]/:/[0-9\-]/).test(c))return void a.preventDefault();if(!n&&"-"===c)return void a.preventDefault();if(!e&&"."===c)return void a.preventDefault();if("."===c&&t.value&&t.value.includes("."))return void a.preventDefault()}catch(t){}})}async function requestMicPermission(){try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(t=>t.stop()),!0}catch(t){return document.getElementById("status")?setStatus("Microphone permission denied. Please allow access and try again.","error"):alert("Please allow microphone access when the browser asks."),!1}}async function populateDeviceLists(){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return;if(__populateDevicesInProgress)return void console.debug("populateDeviceLists: already in progress — skipping");__populateDevicesInProgress=!0,console.debug("populateDeviceLists: start");if(!await requestMicPermission())return console.debug("populateDeviceLists: permission denied"),void(__populateDevicesInProgress=!1);let t="unknown";try{if(navigator.permissions&&"function"==typeof navigator.permissions.query)try{const e=await navigator.permissions.query({name:"microphone"});t=e&&e.state?e.state:t}catch(t){}}catch(t){}const e=document.getElementById("micSelect"),n=document.getElementById("speakerSelect");if(!e||!n)return;const a=e.value,c=n.value,s=document.getElementById("detectBtn");s&&(s.disabled=!0);const o=document.getElementById("status");if(o){setStatus("Scanning devices");const t=document.createElement("span");t.className="spinner";let e=o.querySelector(".status-controls");e||(e=document.createElement("div"),e.className="status-controls",e.style.marginTop="0.25rem",o.appendChild(e)),e.appendChild(t)}e.innerHTML="",n.innerHTML="";let i=[];try{console.debug("populateDeviceLists: enumerating devices"),i=await navigator.mediaDevices.enumerateDevices()}catch(a){console.warn("populateDeviceLists: enumerateDevices failed",a),s&&(s.disabled=!1);const c=document.createElement("option");c.disabled=!0,c.textContent="Could not enumerate devices",e.appendChild(c),n.appendChild(c.cloneNode(!0));try{const e=buildDeviceDiagnostics(i||[],t);o&&showStatusWithDetails("Could not enumerate audio devices. Check microphone permission.","error",e,async()=>{try{__autoDeviceAllowed=!0,await populateDeviceLists()}catch(t){console.warn("Retry populateDeviceLists failed",t)}})}catch(t){o&&setStatus("Could not enumerate audio devices. Check microphone permission.","error")}return}finally{s&&(s.disabled=!1)}if(__populateDevicesInProgress=!1,i.forEach(t=>{const a=document.createElement("option");a.value=t.deviceId||"",a.textContent=t.label||`${t.kind} (${(t.deviceId||"").slice(0,8)})`,"audioinput"===t.kind&&e&&e.appendChild(a),"audiooutput"===t.kind&&n&&supportsSetSinkId()&&n.appendChild(a)}),0===e.options.length){const t=document.createElement("option");t.disabled=!0,t.textContent="No microphones found",e.appendChild(t)}if(0===n.options.length){const t=document.createElement("option");t.disabled=!0,t.textContent="No speakers found",n.appendChild(t)}try{supportsSetSinkId()||n&&(n.disabled=!0,n.style.display="none")}catch(t){}a&&(e.value=a),c&&(n.value=c);try{const a=buildDeviceDiagnostics(i,t);o&&showStatusWithDetails(`Found ${e.options.length} mic(s) and ${n.options.length} speaker(s)`,"success",a,async()=>{try{__autoDeviceAllowed=!0,await populateDeviceLists()}catch(t){console.warn("Retry populateDeviceLists failed",t)}})}catch(t){o&&(setStatus(`Found ${e.options.length} mic(s) and ${n.options.length} speaker(s)`,"success"),setTimeout(clearStatus,3e3))}console.debug("populateDeviceLists: finished",{mics:e.options.length,speakers:n.options.length})}export function initControls({onStart:t=()=>{},onCalibrate:e=()=>{},onNewParticipant:n=()=>{}}={}){const a=()=>{if(!(()=>{try{const t=navigator.userAgent||"",e=/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(t),n=window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;return e||n}catch(t){return!1}})()&&supportsSetSinkId())try{const t=document.getElementById("detectBtn");t&&(t.style.display="")}catch(t){}else try{const t=document.getElementById("detectBtn");t&&(t.style.display="none");const e=document.getElementById("micLabel");e&&(e.style.display="none");const n=document.getElementById("speakerSelect");if(n&&n.parentNode&&(n.parentNode.style.display="none"),!supportsSetSinkId()){const t=document.getElementById("devices");if(t){const e=document.createElement("div");e.className="system-output-note input-hint",e.textContent="Audio input/output is controlled by your device — use system controls (Control Center or OS settings) to change microphones or speakers.",t.appendChild(e)}}}catch(t){}let a=null;const c=getEl("listenBtn");async function s(){if(__isListening||a)return;__isListening=!0;let t=!1;try{await initMic(),await ensureAudioRunning(),t=!0}catch(e){console.warn("startListening: priming audio failed",e),t=!1}try{if(t)try{setStatus("Audio primed","success"),scheduleClear(5e3)}catch(t){}}catch(t){}try{setListenMode(!0)}catch(t){console.warn("Could not set Listen mode:",t)}a=requestAnimationFrame(async function t(e){let n=0;try{const t=await pollDetector(e);"number"==typeof t&&(n=t)}catch(t){console.warn("Listen loop error",t)}const c=document.getElementById("rmsValue");if(c)try{c.textContent="number"==typeof n&&Number.isFinite(n)?n.toFixed(2):String(n)}catch(t){c.textContent=String(Math.round(n))}var s;n>1&&await(s=1e3,new Promise(t=>setTimeout(t,s))),a&&(a=requestAnimationFrame(t))}),c&&(c.textContent="Stop")}function o(){try{a&&(cancelAnimationFrame(a),a=null,c&&(c.textContent="Listen"));try{setListenMode(!1)}catch(t){console.warn("Could not clear Listen mode",t)}try{stopMic()}catch(t){console.warn("stopListening: stopMic failed",t)}__isListening=!1,clearStatus()}catch(t){console.warn("stopListening: unexpected error",t)}}let i=!1,r=!1;function l(t,e){try{void 0===e&&(e=t),k&&(k.disabled=!t,k.setAttribute("aria-disabled",String(!t)),t?k.classList.remove("disabled"):k.classList.add("disabled"))}catch(t){}}function d(t){try{M&&(M.disabled=!t,M.setAttribute("aria-disabled",String(!t)),t?M.classList.remove("disabled"):M.classList.add("disabled"))}catch(t){}}function u(t){try{if(!M)return;t?M.classList.add("btn-anim"):M.classList.remove("btn-anim")}catch(t){}}function m(){try{const n=document.getElementById("courseSelect"),a=document.getElementById("stageSelect"),c=M;function t(){try{if(!c||O)return;_=c.parentNode,_&&(P=c.nextSibling,_.removeChild(c),O=!0,console.debug("Next button detached from DOM"))}catch(t){console.warn("detachNextButton failed",t)}}function e(){try{if(!c||!O)return;_&&(P&&P.parentNode===_?_.insertBefore(c,P):_.appendChild(c),O=!1,_=null,P=null,console.debug("Next button restored to DOM"))}catch(t){console.warn("restoreNextButton failed",t)}}if(!n||!a){try{t()}catch(p){}return void l(!0)}if(!n.value){try{t()}catch(h){}return void l(!0)}const s=a.value,m=Boolean(s)&&"scoring"!==s;if(m){l(!i,i||!!r)}else l(!1,!1);if("scoring"===s){try{e()}catch(y){}d(!0),u(!0)}else if(m&&i){try{e()}catch(g){}d(!1),u(!1)}else{try{e()}catch(v){}d(!0),u(!1)}if(!m){try{Z()}catch(f){}try{o()}catch(b){}try{stopMic()}catch(E){}try{stopTimer()}catch(L){}try{l(!1,!1)}catch(S){}}try{n&&(n.disabled=i,n.setAttribute("aria-disabled",String(i))),a&&(a.disabled=i,a.setAttribute("aria-disabled",String(i)))}catch(w){}}catch(C){}}navigator.mediaDevices&&!__deviceChangeHandlerAdded&&(navigator.mediaDevices.addEventListener("devicechange",async()=>{try{if(console.debug("devicechange event"),!__autoDeviceAllowed)return void console.debug("devicechange: auto device scan not allowed by user");console.debug("devicechange: auto device scan allowed; calling populateDeviceLists"),await populateDeviceLists()}catch(t){console.warn("devicechange handler failed",t)}}),__deviceChangeHandlerAdded=!0);const p=document.getElementById("totalSecInput"),h=document.getElementById("shotsCountInput"),y=document.getElementById("thresholdInput"),g=document.getElementById("debounceInput");try{sanitizeNumericInput(p,{allowDecimal:!1,allowNegative:!1,maxLength:6})}catch(t){}try{sanitizeNumericInput(h,{allowDecimal:!1,allowNegative:!1,maxLength:4})}catch(t){}try{sanitizeNumericInput(y,{allowDecimal:!0,allowNegative:!1,maxLength:7})}catch(t){}try{sanitizeNumericInput(g,{allowDecimal:!1,allowNegative:!1,maxLength:6})}catch(t){}try{p&&p.addEventListener("paste",t=>{try{t.preventDefault()}catch(t){}})}catch(t){}try{p&&p.addEventListener("drop",t=>{try{t.preventDefault()}catch(t){}})}catch(t){}try{h&&h.addEventListener("paste",t=>{try{t.preventDefault()}catch(t){}})}catch(t){}try{h&&h.addEventListener("drop",t=>{try{t.preventDefault()}catch(t){}})}catch(t){}p&&p.addEventListener("change",t=>{try{let e=String(t.target.value||"");if(e=e.replace(/[^0-9]/g,""),""===e)return;const n=Math.floor(Number(e));if(!Number.isFinite(n)||n<=0)return;t.target.value=String(n),setTotalSeconds(n)}catch(t){}}),h&&h.addEventListener("change",t=>{try{let e=String(t.target.value||"");if(e=e.replace(/[^0-9]/g,""),""===e)return;const n=parseInt(e,10);if(!Number.isFinite(n)||n<0)return;t.target.value=String(n),setExpectedShots(n)}catch(t){}}),y&&y.addEventListener("input",t=>{const e=parseFloat(t.target.value);if(!Number.isFinite(e))return;const n=Math.min(127,Math.max(0,e));setThreshold(n);const a=document.getElementById("thresholdValue");a&&(a.textContent=String(Math.round(n)))}),g&&g.addEventListener("input",t=>{const e=Number(t.target.value);if(!Number.isFinite(e)||e<0)return;setDebounceMs(Math.round(e));const n=document.getElementById("debounceValue");n&&(n.textContent=String(Math.round(e)))});const v=document.getElementById("beepOnShot");if(v){try{v.checked=!!getBeepOnShot()}catch(t){}v.addEventListener("change",t=>{try{setBeepOnShot(Boolean(t.target.checked))}catch(t){console.warn("Failed to set beep-on-shot",t)}})}const f=document.getElementById("showRmsColumn");if(f){f.checked=!1;try{setRmsColumnVisible(Boolean(f.checked))}catch(t){}f.addEventListener("change",t=>{try{setRmsColumnVisible(Boolean(t.target.checked))}catch(t){console.warn("Failed to toggle RMS column",t)}})}const b=[80,100,120,140,160],E=document.getElementById("uiZoomMinus"),L=document.getElementById("uiZoomPlus"),S=document.getElementById("uiZoomValue");function w(t){try{const e=document.documentElement,n=t/100*16;e.style.fontSize=`${n}px`,S&&(S.textContent=`${t}%`)}catch(t){console.warn("applyZoom failed",t)}}try{const t=navigator.userAgent||"",e=/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(t),n=window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;w(e||n?160:100)}catch(t){}try{window.addEventListener("load",()=>{try{const t=navigator.userAgent||"",e=/Mobi|Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(t),n=window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;(e||n)&&w(160)}catch(t){}})}catch(t){}function C(t){try{const e=(()=>{const t=S?S.textContent.replace("%",""):"100";return Number(t)})(),n=Math.max(0,b.indexOf(function(t){for(let e=0;e<b.length;e++)if(b[e]===t)return t;let e=b[0],n=Math.abs(t-e);for(let a of b){const c=Math.abs(t-a);c<n&&(n=c,e=a)}return e}(e))),a=Math.min(b.length-1,Math.max(0,n+(t>0?1:-1)));w(b[a])}catch(t){console.warn("stepZoom failed",t)}}E&&(E.addEventListener("click",()=>C(-1)),E.addEventListener("touchstart",t=>{try{t.preventDefault(),C(-1)}catch(t){}},{passive:!1})),L&&(L.addEventListener("click",()=>C(1)),L.addEventListener("touchstart",t=>{try{t.preventDefault(),C(1)}catch(t){}},{passive:!1}));const I=document.getElementById("themeToggle"),D="shot-timer-theme";function B(t){try{if("dark"===t){document.documentElement.setAttribute("data-theme","dark");const t=document.getElementById("themeBtn");t&&(t.setAttribute("aria-pressed","true"),t.textContent="☀️")}else{document.documentElement.removeAttribute("data-theme");const t=document.getElementById("themeBtn");t&&(t.setAttribute("aria-pressed","false"),t.textContent="🌙")}I&&(I.checked="dark"===t)}catch(t){console.warn("applyTheme failed",t)}}try{const t=localStorage.getItem(D);if(t)B(t);else{const t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;I&&(I.checked=t)}}catch(t){}I&&I.addEventListener("change",t=>{const e=t.target.checked?"dark":"light";B(e);try{localStorage.setItem(D,e)}catch(t){}});const x=document.getElementById("speakerSelect");try{if(x&&supportsSetSinkId())x.addEventListener("change",async t=>{try{await setOutputDevice(t.target.value),setStatus(`Using output device: ${x.selectedOptions[0]?.text||t.target.value}`,"success")}catch(t){setStatus("Failed to set output device — this browser may not support setSinkId.","error")}});else if(x){x.style.display="none";const t=x.parentNode;t&&(t.style.display="none");try{const e="shot-timer-system-output-note-dismissed";if(!(()=>{try{return"1"===localStorage.getItem(e)}catch(t){return!1}})()){let n=document.getElementById("systemOutputNote");if(!n){n=document.createElement("div"),n.id="systemOutputNote",n.className="system-output-note input-hint";const a=document.createElement("span");a.className="info-icon",a.setAttribute("role","img"),a.setAttribute("aria-label","Info"),a.textContent="ℹ️",n.appendChild(a);const c=document.createElement("span");c.textContent="Using system audio output — change output via your device (Control Center on iPhone, system audio settings, or Bluetooth).",n.appendChild(c);const s=document.createElement("button");if(s.type="button",s.className="dismiss-note-btn",s.setAttribute("aria-label","Dismiss system audio note"),s.textContent="Got it",s.addEventListener("click",()=>{try{localStorage.setItem(e,"1")}catch(t){}n.style.display="none"}),n.appendChild(s),t&&t.parentNode)t.parentNode.appendChild(n);else{const t=document.getElementById("devices");t&&t.appendChild(n)}}}}catch(t){}}}catch(t){}const k=$("#startBtn"),M=document.getElementById("nextStageBtn"),T=$("#calibrateBtn"),N=$("#detectBtn"),A=document.getElementById("resetCourseBtn");let _=null,P=null,O=!1;document.querySelector(".action-group");let q=null,F=null,R=null,H=null,j=!1;function U(){try{q&&(clearTimeout(q),q=null)}catch(t){}try{F&&(clearInterval(F),F=null,R=null)}catch(t){}try{const t=document.getElementById("display");t&&(t.classList.remove("postfinish"),null!==H&&(t.textContent=H,H=null))}catch(t){}}function V(t){try{const e=document.querySelector(".svg-logo");if(!e)return;t?e.classList.add("active"):e.classList.remove("active"),j=!!t}catch(t){console.warn("setActiveStageLogo failed",t)}}try{const t=document.querySelectorAll(".svg-logo");if(t&&t.length>0){try{const e="shot-timer-logo-tip-dismissed";if(!(()=>{try{return"1"===localStorage.getItem(e)}catch(t){return!1}})()){const n=t[0],a=document.createElement("div");a.className="logo-tip input-hint",a.style.display="flex",a.style.alignItems="center",a.style.gap="0.5rem",a.style.marginBottom="0.5rem",a.setAttribute("role","status"),a.setAttribute("aria-live","polite");const c=document.createElement("span");c.textContent="Tip: double-tap or double-click the logo to quickly cycle courses.";const s=document.createElement("button");s.type="button",s.className="btn-secondary",s.textContent="Got it!",s.setAttribute("aria-label","Dismiss logo tip"),s.addEventListener("click",()=>{try{localStorage.setItem(e,"1")}catch(t){}try{a.remove()}catch(t){}}),a.appendChild(c),a.appendChild(s);try{(n.parentNode||document.body).insertBefore(a,n)}catch(t){document.body.insertBefore(a,document.body.firstChild)}}}catch(t){}t.forEach(t=>{try{t.style.cursor="pointer",t.addEventListener("dblclick",e=>{try{W(t)}catch(t){console.warn("logo dblclick cycle failed",t)}});let e=0;t.addEventListener("touchstart",n=>{const a=Date.now();if(a-e<350)return n.cancelable&&n.preventDefault(),n.stopPropagation&&n.stopPropagation(),W(t),void(e=0);e=a},{passive:!1})}catch(t){}})}}catch(t){}function W(t){try{const e=document.getElementById("courseSelect");if(!e)return;if(i){try{setStatus("Cannot change course while timer is running","error"),scheduleClear(3e3)}catch(t){}return}const n=e.options;if(!n||0===n.length)return;let a=e.selectedIndex;if(-1===a?a=0:a+=1,a>=n.length){try{e.value=""}catch(t){e.selectedIndex=-1}try{e.dispatchEvent(new Event("change",{bubbles:!0}))}catch(t){}return void(t&&transientPress(t))}e.selectedIndex=a;try{e.dispatchEvent(new Event("change",{bubbles:!0}))}catch(t){}t&&transientPress(t)}catch(t){console.warn("cycleCourse failed",t)}}let z=null;function Z(){try{z&&(clearInterval(z),z=null)}catch(t){try{z&&(clearTimeout(z),z=null)}catch(t){}}try{k&&(k.disabled=!1)}catch(t){}try{d(!0),u(!1)}catch(t){}}k&&k.addEventListener("click",async()=>{transientPress(k);try{o(),setListenMode(!1)}catch(t){}try{d(!1),u(!1)}catch(t){}if(r&&!i){if(!await requestMicPermission()){try{setStatus("Microphone required to repeat stage. Start cancelled.","error")}catch(t){}return}try{incrementStageAttempt()}catch(t){}try{setStageContext({})}catch(t){}r=!1}try{if(k.classList.contains("running")){try{resetTimer()}catch(t){}return k.classList.remove("running"),void k.classList.remove("btn-anim")}}catch(t){}try{resetTimer()}catch(t){}try{k.disabled=!0}catch(t){}try{await initMic()}catch(t){}try{await ensureAudioRunning()}catch(t){}const e=1e3+Math.floor(2001*Math.random()),n=document.getElementById("display");n&&n.classList.add("prestart");const a=performance.now();z=setInterval(()=>{const c=performance.now()-a,s=Math.max(0,e-c);n&&(n.textContent=formatTime(Math.ceil(s)));const o=document.getElementById("startBtn");if(o&&(o.classList.add("btn-anim"),o.classList.add("running")),s<=0){Z(),n&&n.classList.remove("prestart");const e=document.getElementById("startBtn");e&&e.classList.remove("btn-anim");try{playBeep()}catch(t){}try{V(!0)}catch(t){}"function"==typeof t&&t({skipInitialBeep:!0})}},100)}),M&&M.addEventListener("click",()=>{try{M.classList.add("btn-anim")}catch(t){}});try{M&&M.addEventListener("click",()=>{try{U(),V(!1)}catch(t){}})}catch(t){}try{A&&A.addEventListener("click",()=>{try{U(),V(!1)}catch(t){}})}catch(t){}try{const t=document.getElementById("courseSelect"),e=document.getElementById("stageSelect");if(t&&t.addEventListener("change",m),e&&e.addEventListener("change",m),m(),M&&"undefined"!=typeof MutationObserver){new MutationObserver(()=>{try{if("Save"===(M.textContent||"").trim()){try{l(!1,!1)}catch(t){}try{d(!0),u(!0)}catch(t){}}else try{m()}catch(t){}}catch(t){}}).observe(M,{characterData:!0,childList:!0,subtree:!0})}}catch(t){}function G(){const t=document.getElementById("collapsedArea"),e=t&&!t.classList.contains("collapsed"),n=Boolean(e);N&&(N.style.display=n?"":"none"),c&&(c.style.display=n?"":"none"),T&&(T.style.display=n?"":"none")}document.addEventListener("stageFinished",()=>{try{k&&(k.classList.remove("running"),k.classList.remove("btn-anim"))}catch(t){}try{M&&M.classList.remove("btn-anim")}catch(t){}try{m()}catch(t){}try{i=!1}catch(t){}try{d(!0),u(!0)}catch(t){}try{l(!1,!1)}catch(t){}try{U(),V(!0);const t=performance.now();R=t+2e3;try{const t=document.getElementById("display");t&&(H=t.textContent,t.classList.add("postfinish"))}catch(t){}try{F=setInterval(()=>{try{const t=Math.max(0,Math.round(R-performance.now())),e=document.getElementById("display");e&&(e.textContent=formatTime(t))}catch(t){}},100)}catch(t){}q=setTimeout(()=>{try{stopTimer()}catch(t){console.warn("autoStop: stopTimer failed",t)}try{o()}catch(t){console.warn("autoStop: stopListening failed",t)}try{stopMic()}catch(t){console.warn("autoStop: stopMic failed",t)}try{d(!0),u(!0)}catch(t){}try{r=!0}catch(t){}q=null},2e3)}catch(t){console.warn("Failed to schedule auto-stop",t)}}),document.addEventListener("stageStarted",()=>{try{k&&(k.classList.remove("btn-anim"),k.classList.remove("running"))}catch(t){}try{M&&M.classList.remove("btn-anim")}catch(t){}try{m()}catch(t){}try{i=!0}catch(t){}try{d(!1),u(!1)}catch(t){}try{l(!1,!1)}catch(t){}try{V(!0)}catch(t){}}),document.addEventListener("timerStopped",()=>{try{k&&k.classList.remove("btn-anim")}catch(t){}try{M&&M.classList.remove("btn-anim")}catch(t){}try{m()}catch(t){}try{i=!1}catch(t){}try{d(!0),u(!0)}catch(t){}try{U(),V(!1)}catch(t){}try{const t=document.getElementById("courseSelect"),e=document.getElementById("stageSelect");t&&e&&t.value?l(!1,!1):l(!0,!1)}catch(t){}try{r=!0}catch(t){}}),A&&A.addEventListener("click",()=>{Z(),"function"==typeof n&&n()}),T&&T.addEventListener("click",()=>{Z(),"function"==typeof e&&e()}),c&&c.addEventListener("click",async()=>{"Listen"===c.textContent?await s():o()}),N&&N.addEventListener("click",async()=>{try{__autoDeviceAllowed=!0;try{const t=document.getElementById("status");t&&(t.dataset.manuallyClosed="0")}catch(t){}await populateDeviceLists();let t=!1;try{await initMic(),await ensureAudioRunning(),t=!0}catch(e){t=!1,console.warn("Detect: audio priming failed",e)}if(t)try{setStatus("Audio primed","success"),scheduleClear(5e3)}catch(t){}else try{setStatus("Audio priming failed (try Listen)","error"),scheduleClear(3e3)}catch(t){}}catch(t){console.warn("Detect click failed",t)}}),N&&N.addEventListener("click",()=>console.debug("Detect button clicked; user allowed auto-detection")),G();const J=document.getElementById("collapseToggle");J&&J.addEventListener("click",()=>{setTimeout(G,50)});try{window.addEventListener("beforeunload",()=>{try{Z(),o()}catch(t){}})}catch(t){}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",a):a()}export function setUiTotalSecondsUI(t){const e=document.getElementById("totalSecInput");if(e){e.value=String(t);try{setTotalSeconds(Number(t))}catch(t){}}}export function setUiExpectedShotsUI(t){const e=document.getElementById("shotsCountInput");if(e){e.value=String(t);try{setExpectedShots(Number(t))}catch(t){}}}