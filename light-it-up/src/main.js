const el=t=>document.querySelector(t),PALETTE=[[255,0,0],[0,0,255],[119,255,255],[255,52,86],[125,249,255],[255,128,0],[176,177,17],[218,94,17]];let _offColor=[0,0,255];const _midColor=[255,255,255],_onColor=[0,255,0],_goldColor=[255,215,0],_leds=10,CONFIG={sublevels:10,levels:[{baseMs:800},{baseMs:710},{baseMs:620},{baseMs:530},{baseMs:440},{baseMs:350},{baseMs:350,difficult:!0},{baseMs:300,difficult:!0},{baseMs:250,difficult:!0},{baseMs:200,difficult:!0},{baseMs:100,hidden:!0,difficult:!0}]};function visibleLevels(){return(CONFIG?.levels||[]).filter(t=>!t.hidden)}function IsDifficultLevel(t){const e=CONFIG?.levels?.[t];return!(!e||!e.difficult)}const NOTES={C3:131,C4:262,C5:523,D4:294,E4:330,F4:349,G4:392,A4:440,B3:247,G5:784},helloMelody=[NOTES.C3,NOTES.C3,NOTES.G4,NOTES.C3,0,NOTES.C4,NOTES.C4,NOTES.B3,NOTES.C4];let ctx=null,audioUnlocked=!1;function createAudioContext(){const t=window.AudioContext||window.webkitAudioContext;if(!t)return null;try{return new t}catch{return null}}async function ensureAudio(t=!1){if(ctx||(ctx=createAudioContext()),!ctx)return!1;if("running"!==ctx.state)try{await ctx.resume()}catch{}if(t&&ctx&&"running"===ctx.state)try{const t=ctx.createOscillator(),e=ctx.createGain();e.gain.value=1e-4,t.connect(e),e.connect(ctx.destination),t.start(),t.stop(ctx.currentTime+.01)}catch{}return ctx&&"running"===ctx.state}function unlockNowFromGesture(){if(audioUnlocked)return!0;if(ctx||(ctx=createAudioContext()),!ctx)return!1;try{ctx.resume()}catch{}try{const t=ctx.createBuffer(1,1,22050),e=ctx.createBufferSource();e.buffer=t,e.connect(ctx.destination),e.start(0)}catch{}return audioUnlocked=ctx&&"running"===ctx.state||audioUnlocked,audioUnlocked}function unlockAudioOnFirstGesture(){if(audioUnlocked)return;const t=e=>{const n=unlockNowFromGesture();try{ensureAudio(!0)}catch{}n&&["pointerdown","touchstart","touchend","mousedown","keydown"].forEach(e=>window.removeEventListener(e,t,!0))};["pointerdown","touchstart","touchend","mousedown","keydown"].forEach(e=>window.addEventListener(e,t,{capture:!0,passive:!1}))}async function playTone(t,e,n=0){if(!t)return new Promise(t=>setTimeout(t,e));if(isMuted)return new Promise(t=>setTimeout(t,e));if(!await ensureAudio(!1)||!ctx)return new Promise(t=>setTimeout(t,e));const i=ctx.createOscillator(),s=ctx.createGain();i.frequency.value=t,i.type="sine",i.connect(s),s.connect(ctx.destination);const o=Math.max(ctx.currentTime,ctx.currentTime+n),a=Math.max(.001,e/1e3),l=Math.min(.01,.2*a),r=Math.min(.02,.4*a);s.gain.setValueAtTime(0,o),s.gain.linearRampToValueAtTime(.08,o+l);const c=Math.max(o,o+a-r);return s.gain.setValueAtTime(.08,c),s.gain.linearRampToValueAtTime(1e-4,c+r),i.start(o),i.stop(c+r),i.onended=()=>{try{i.disconnect(),s.disconnect()}catch{}},new Promise(t=>setTimeout(t,e))}async function playChord(t,e,n=0,i=0){if(!Array.isArray(t)||0===t.length)return new Promise(t=>setTimeout(t,e));if(isMuted)return new Promise(t=>setTimeout(t,e));if(!await ensureAudio(!1)||!ctx)return new Promise(t=>setTimeout(t,e));const s=.08/Math.max(1,Math.min(t.length,4)),o=Math.max(ctx.currentTime,ctx.currentTime+n),a=t.slice(),l=Math.max(0,i)/1e3;l>0&&(a.sort((t,e)=>t-e),Math.random()<.5&&a.reverse());const r=Math.max(.001,e/1e3),c=Math.min(.01,.2*r),u=Math.min(.02,.4*r);a.forEach((t,e)=>{const n=ctx.createOscillator(),i=ctx.createGain();n.frequency.value=t,n.type="sine",n.connect(i),i.connect(ctx.destination);const a=o+l*e,d=a+r;i.gain.setValueAtTime(0,a),i.gain.linearRampToValueAtTime(s,a+c);const f=Math.max(a,d-u);i.gain.setValueAtTime(s,f),i.gain.linearRampToValueAtTime(1e-4,f+u),n.start(a),n.stop(f+u),n.onended=()=>{try{n.disconnect(),i.disconnect()}catch{}}});const d=e+Math.max(0,i)*(a.length-1);return new Promise(t=>setTimeout(t,d))}unlockAudioOnFirstGesture();let bassOsc=null,bassGain=null;async function startBass(){if(bassOsc||isMuted)return;if(!await ensureAudio(!1)||!ctx)return;const t=ctx.createOscillator(),e=ctx.createGain();t.type="sine",t.frequency.value=NOTES.C3,e.gain.value=0,t.connect(e),e.connect(ctx.destination);const n=ctx.currentTime;e.gain.setValueAtTime(0,n),e.gain.linearRampToValueAtTime(.05,n+.05);try{t.start(n)}catch{}bassOsc=t,bassGain=e}function stopBass(){if(!bassOsc||!bassGain||!ctx)return;const t=ctx.currentTime;try{bassGain.gain.cancelScheduledValues(t),bassGain.gain.setValueAtTime(bassGain.gain.value,t),bassGain.gain.linearRampToValueAtTime(1e-4,t+.06),bassOsc.stop(t+.07)}catch{}const e=bassOsc,n=bassGain;bassOsc=null,bassGain=null,e.onended=()=>{try{e.disconnect(),n.disconnect()}catch{}}}function randInt(t){return Math.floor(Math.random()*t)}function closestFromEventTarget(t,e){let n=t;for(;n&&1!==n.nodeType;)n=n.parentNode;return n&&n.closest?n.closest(e):null}const app=document.getElementById("app");app.innerHTML='\n  <div class="title">Light It Up</div>\n  <div class="game">\n  <div class="scoreline"><div class="mute-container"><button id="muteBtn" class="mute-btn" aria-pressed="false" aria-label="Sound On">Sound: On</button><button id="a11yBtn" class="mute-btn" aria-pressed="false" aria-label="Accessibility Off">Accessibility: Off</button><button id="difficultyBtn" class="mute-btn" aria-label="Difficulty Normal">Difficulty: Normal</button></div></div>\n  <div class="instructions">Use the Left and Right Arrow keys. Make all the lights GREEN.</div>\n    \n  <div id="iosAudioTip" class="ios-audio-tip" style="display:none">No sound? On iPhone, ensure the Silent switch is off and volume is up. On iPad, check Control Center (bell icon / Silent Mode) and volume.</div>\n  <div class="leds" id="leds"><div id="playButtonWrap" class="center-button"><button id="startBtn" class="play-btn" aria-label="Start">Start</button></div><div id="timerOverlay" class="center-button timer-overlay" aria-hidden="true"></div></div>\n    <div class="controls">\n  <div class="row center"><div id="status"><span id="statusText"></span></div></div>\n    </div>\n  </div>\n  <div class="footer">© 2025 Rob Morrison — Light It Up</div>\n';const ledsRoot=el("#leds"),ledEls=new Array(10),startAngle=135,arc=270;for(let t=0;t<10;t++){const e=document.createElement("div");e.className="led",e.dataset.pos=t,e.textContent="";const n=(135+t/9*270)*(Math.PI/180),i=140,s=Math.cos(n)*i,o=Math.sin(n)*i;e.style.transform=`translate(calc(-50% + ${s}px), calc(-50% + ${o}px))`,ledsRoot.appendChild(e),ledEls[t]=e}const status=el("#status"),statusText=document.getElementById("statusText"),iosAudioTip=el("#iosAudioTip"),muteBtn=el("#muteBtn"),a11yBtn=el("#a11yBtn"),difficultyBtn=el("#difficultyBtn"),startBtn=document.getElementById("startBtn"),playButtonWrap=document.getElementById("playButtonWrap"),timerOverlay=document.getElementById("timerOverlay"),hideInstructions=()=>document.querySelectorAll(".instructions").forEach(t=>t.classList.add("is-hidden")),hideIosTip=()=>{const t=document.getElementById("iosAudioTip");t&&t.classList.add("is-hidden")},hideStatus=()=>{status&&(status.classList.add("is-hidden"),status.style.visibility="hidden",status.style.opacity="0")},showStatus=t=>{status&&(status.classList.remove("is-hidden"),status.style.visibility="visible",status.style.opacity="1",statusText&&(statusText.textContent=t))};function updateInstructionsText(){const t=document.querySelector(".instructions");if(!t)return;const e=isTouch?"Tap the left or right half of the screen.":"Use the Left and Right Arrow keys.",n=isA11ySymbols?"Get STARS on all spots.":"Make all the lights GREEN.";t.innerHTML=`${e}<br>${n}`}let isPlaying=!1,isMuted=!1,isA11ySymbols=!1,difficultyMode="normal",currentLocks=new Array(10).fill(0),lastActiveLedIndex=-1,currentIsDifficultLevel=!1,gameStartTs=0,winElapsedMs=null,timerRaf=0,isNewBestThisRun=!1,runDifficulty="normal",winAnimInterval=0,winAnimFlip=!1;function loadBestTimes(){try{const t=localStorage.getItem("liu_bestTimes");if(!t)return{normal:null,fast:null,brutal:null};const e=JSON.parse(t);return{normal:Number.isFinite(e?.normal)?e.normal:null,fast:Number.isFinite(e?.fast)?e.fast:null,brutal:Number.isFinite(e?.brutal)?e.brutal:null}}catch{return{normal:null,fast:null,brutal:null}}}function saveBestTimes(t){try{localStorage.setItem("liu_bestTimes",JSON.stringify(t))}catch{}}let bestTimes=loadBestTimes();function recordIfBest(t,e){if(!(t>=0))return!1;bestTimes||(bestTimes={normal:null,fast:null,brutal:null});const n=bestTimes[e];return(null==n||t<n)&&(bestTimes[e]=t,saveBestTimes(bestTimes),!0)}function formatElapsed(t){const e=Math.max(0,Math.floor(t||0)),n=Math.floor(e/6e4),i=Math.floor(e%6e4/1e3),s=Math.floor(e%1e3/10),o=t=>String(t).padStart(2,"0");return`${o(n)}:${o(i)}.${o(s)}`}function showTimerOverlay(){timerOverlay&&(timerOverlay.style.display="block",timerOverlay.setAttribute("aria-hidden","false"))}function hideTimerOverlay(){timerOverlay&&(timerOverlay.style.display="none",timerOverlay.setAttribute("aria-hidden","true"))}function startTimerLoop(){if(!timerOverlay)return;cancelTimerLoop();const t=()=>{if(!isPlaying)return;const e=(performance.now?performance.now():Date.now())-gameStartTs;timerOverlay.textContent=formatElapsed(e),timerRaf=requestAnimationFrame(t)};timerRaf=requestAnimationFrame(t)}function cancelTimerLoop(){timerRaf&&(cancelAnimationFrame(timerRaf),timerRaf=0)}let idlePulseInterval=0,idlePulseClearTimers=[];function stopIdleAnimation(){if(idlePulseInterval){try{clearInterval(idlePulseInterval)}catch{}idlePulseInterval=0}if(idlePulseClearTimers&&idlePulseClearTimers.length)for(const t of idlePulseClearTimers)try{clearTimeout(t)}catch{}idlePulseClearTimers=[],clearAll(_offColor),clearSymbols()}function startWinAnimationLoop(t=600){if(winAnimInterval){try{clearInterval(winAnimInterval)}catch{}winAnimInterval=0}winAnimFlip=!1;const e=()=>{winAnimFlip=!winAnimFlip;for(let t=0;t<10;t++){const e=t%2==0;setPixel(t,(winAnimFlip?!e:e)?_onColor:_goldColor)}};e(),winAnimInterval=setInterval(e,Math.max(60,t))}function stopWinAnimationLoop(){if(winAnimInterval){try{clearInterval(winAnimInterval)}catch{}winAnimInterval=0}}function startIdleAnimation(){if(stopIdleAnimation(),isPlaying)return;const t=()=>{if(isPlaying)return;const t=new Set,e=2+randInt(4),n=[];for(let i=0;i<e;i++){let e=randInt(10),i=0;for(;t.has(e)&&i++<20;)e=randInt(10);t.add(e),n.push(e)}const i=120+randInt(121);n.forEach((t,e)=>{const n=e*i+randInt(60),s=setTimeout(()=>{if(isPlaying)return;if(setPixel(t,_onColor),isA11ySymbols){const e=ledNode(t);e&&(e.textContent="★",e.style.color="#eaf2ff")}const e=900+randInt(201),n=setTimeout(()=>{setPixel(t,_offColor);const e=ledNode(t);e&&(e.textContent="",e.style.color="")},e);idlePulseClearTimers.push(n)},n);idlePulseClearTimers.push(s)})};t(),idlePulseInterval=setInterval(t,1400)}function ledNode(t){return ledEls[t]||ledsRoot.querySelector(`[data-pos='${t}']`)}function updateSymbolFor(t){const e=ledNode(t);if(!e)return;const n=currentLocks[t]||0;isA11ySymbols?currentIsDifficultLevel?n>=2?(e.textContent="★",e.style.color="#eaf2ff"):1===n?(e.textContent="+",e.style.color="#0a0a0a"):(e.textContent="",e.style.color=""):n>=1?(e.textContent="★",e.style.color="#eaf2ff"):(e.textContent="",e.style.color=""):(e.textContent="",e.style.color=""),setPixel(t,n<=0?_offColor:currentIsDifficultLevel&&1===n?_midColor:_onColor);try{e.offsetHeight}catch{}}function refreshAccessibilitySymbols(){for(let t=0;t<10;t++)updateSymbolFor(t)}function clearSymbols(){for(let t=0;t<10;t++){const e=ledNode(t);e&&(e.textContent="",e.style.color="")}}function setActiveHighlight(t){if(-1!==lastActiveLedIndex){const t=ledNode(lastActiveLedIndex);t&&t.classList.remove("a11y-active")}if(lastActiveLedIndex=t,!isA11ySymbols)return;const e=ledNode(t);e&&e.classList.add("a11y-active")}let lastActiveAt=performance.now(),creativeModeActive=!1;const INACTIVITY_MS=5e3;function markActive(){lastActiveAt=performance.now(),creativeModeActive=!1}function shouldBeCreative(){return isPlaying&&!leftDown&&!rightDown&&performance.now()-lastActiveAt>=5e3}const isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;if(isTouch){updateInstructionsText();const t=document.querySelectorAll(".instructions");t[1]&&t[1].remove()}updateInstructionsText();try{const t=navigator.userAgent||"";(/iPad|iPhone|iPod/.test(t)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&iosAudioTip&&(iosAudioTip.style.display="block")}catch{}if(muteBtn){const t=()=>{isMuted?(muteBtn.textContent="Sound: Off",muteBtn.setAttribute("aria-pressed","true"),muteBtn.setAttribute("aria-label","Sound Off")):(muteBtn.textContent="Sound: On",muteBtn.setAttribute("aria-pressed","false"),muteBtn.setAttribute("aria-label","Sound On"))};t(),muteBtn.addEventListener("click",e=>{e.preventDefault(),unlockNowFromGesture();try{ensureAudio(!0)}catch{}markActive(),isMuted=!isMuted,isMuted&&stopBass(),t()}),muteBtn.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),unlockNowFromGesture();try{ensureAudio(!0)}catch{}markActive(),isMuted=!isMuted,isMuted&&stopBass(),t()},{passive:!1})}if(a11yBtn){const t=()=>{a11yBtn.textContent="Accessibility: "+(isA11ySymbols?"On":"Off"),a11yBtn.setAttribute("aria-pressed",isA11ySymbols?"true":"false"),a11yBtn.setAttribute("aria-label",isA11ySymbols?"Accessibility On":"Accessibility Off")};t();const e=()=>{isA11ySymbols=!isA11ySymbols,t(),refreshAccessibilitySymbols();const e=-1!==lastActiveLedIndex?ledNode(lastActiveLedIndex):null;e&&(isA11ySymbols?e.classList.add("a11y-active"):e.classList.remove("a11y-active")),isPlaying||updateInstructionsText()};a11yBtn.addEventListener("click",t=>{t.preventDefault(),e()}),a11yBtn.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),e()},{passive:!1})}if(difficultyBtn){const t=()=>{const t="normal"===difficultyMode?"Normal":"fast"===difficultyMode?"Fast":"Brutal";difficultyBtn.textContent=`Difficulty: ${t}`,difficultyBtn.setAttribute("aria-label",`Difficulty ${t}`)},e=()=>{difficultyMode="normal"===difficultyMode?"fast":"fast"===difficultyMode?"brutal":"normal",t()};t(),difficultyBtn.addEventListener("click",t=>{t.preventDefault(),e()}),difficultyBtn.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),e()},{passive:!1})}let leftDown=!1,rightDown=!1;window.addEventListener("keydown",t=>{"ArrowLeft"===t.key&&(leftDown=!0),"ArrowRight"===t.key&&(rightDown=!0),"ArrowLeft"!==t.key&&"ArrowRight"!==t.key||markActive()}),window.addEventListener("keyup",t=>{"ArrowLeft"===t.key&&(leftDown=!1),"ArrowRight"===t.key&&(rightDown=!1)});let abortFlag=!1;function handleTouchSide(t){const e=t.clientX<(window.innerWidth||document.documentElement.clientWidth)/2;leftDown=!!e,rightDown=!e}if(window.addEventListener("keydown",t=>{"Escape"===t.key&&(abortFlag=!0,showStatus("Stopped"),t.preventDefault())}),isTouch){let t=0;window.addEventListener("touchend",e=>{const n=Date.now();n-t<300&&e.preventDefault(),t=n},{passive:!1}),window.addEventListener("touchstart",t=>{t.touches&&t.touches.length>1&&t.preventDefault()},{passive:!1}),window.addEventListener("touchmove",t=>{t.touches&&t.touches.length>1&&t.preventDefault()},{passive:!1}),window.addEventListener("touchstart",t=>{if(closestFromEventTarget(t.target,".mute-container")||closestFromEventTarget(t.target,"#muteBtn"))return;const e=t.changedTouches[0];e&&(handleTouchSide(e),markActive(),t.preventDefault())},{passive:!1}),window.addEventListener("touchmove",t=>{const e=t.changedTouches[0];e&&(handleTouchSide(e),markActive())},{passive:!0});const e=()=>{leftDown=!1,rightDown=!1};window.addEventListener("touchend",()=>{e(),markActive()}),window.addEventListener("touchcancel",()=>{e(),markActive()})}const _pixelColorCache=new Array(10).fill("");function setPixel(t,e){const n=ledEls[t]||ledsRoot.querySelector(`[data-pos='${t}']`);if(!n)return;const i=`rgb(${e[0]},${e[1]},${e[2]})`;_pixelColorCache[t]!==i&&(n.style.backgroundColor=i,_pixelColorCache[t]=i)}function clearAll(t){const e=`rgb(${t[0]},${t[1]},${t[2]})`;for(let t=0;t<10;t++)if(_pixelColorCache[t]!==e){const n=ledEls[t];n&&(n.style.backgroundColor=e,_pixelColorCache[t]=e)}}async function PlayMusic(t){for(const e of t)await playTone(e||0,120),await new Promise(t=>setTimeout(t,20))}async function PlayGame(){if(!CONFIG||!Array.isArray(CONFIG.levels)||0===CONFIG.levels.length||!Number.isFinite(CONFIG.sublevels)||CONFIG.sublevels<=0)return void showStatus("No levels configured");const t=visibleLevels().length;await PlayMusic(helloMelody),hideInstructions(),hideIosTip(),stopIdleAnimation(),await Countdown();try{gameStartTs=performance.now()}catch{gameStartTs=Date.now()}timerOverlay&&(timerOverlay.textContent=formatElapsed(0)),showTimerOverlay(),startTimerLoop();const e=[];for(let n=0;n<t;n++)e.push(n);for(let t=0;t<CONFIG.levels.length;t++)CONFIG.levels[t].hidden&&e.push(t);const n=e.length>0?e[e.length-1]:-1;for(let t=0;t<e.length;t++){const i=e[t];if(showStatus(`Level ${i+1}`),abortFlag)return abortFlag=!1,void showStatus("Stopped");const s=i===n;await runLevel(i,s)}if(await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),showStatus("You won!"),null==winElapsedMs){try{winElapsedMs=performance.now()-gameStartTs}catch{winElapsedMs=null}try{null!=winElapsedMs&&(isNewBestThisRun=recordIfBest(winElapsedMs,runDifficulty)||isNewBestThisRun)}catch{}cancelTimerLoop(),timerOverlay&&null!=winElapsedMs&&(timerOverlay.textContent=formatElapsed(winElapsedMs)+(isNewBestThisRun?" ★":""))}stopBass(),startWinAnimationLoop(600)}async function WinAnimation(t=8,e=220){for(let n=0;n<t;n++){const t=n%2==1;for(let e=0;e<10;e++){const n=e%2==0;setPixel(e,(t?!n:n)?_onColor:_goldColor)}await new Promise(t=>setTimeout(t,e))}for(let t=0;t<10;t++)setPixel(t,t%2==0?_onColor:_goldColor)}async function Countdown(){const t=[[255,0,0],[255,255,0],[0,255,0]],e=["3 ..","2 ..","1 .."];for(let n=0;n<t.length;n++){try{showStatus(e[n])}catch{}clearAll(t[n]),await playTone(262,700),await new Promise(t=>setTimeout(t,300))}clearAll(_offColor)}function scaledMs(t){let e=1;"fast"===difficultyMode?e=.5:"brutal"===difficultyMode&&(e=.25);return Math.max(1,Math.floor(t*e))}async function runLevel(t,e=!1){const n=scaledMs(CONFIG.levels[t].baseMs),i=t>=CONFIG.levels.length-1,s=i?n:scaledMs(CONFIG.levels[t+1].baseMs),o=i?0:(s-n)/CONFIG.sublevels;let a=n;for(let n=0;n<CONFIG.sublevels;n++){if(abortFlag)return;showStatus(`Level ${t+1} - ${n+1}`);const i=e&&n===CONFIG.sublevels-1;await runSublevel(t,n,a,i),await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),resetBoardForNextSublevel(),a+=o}}function resetBoardForNextSublevel(){if(_offColor=PALETTE[randInt(PALETTE.length)],clearAll(_offColor),currentLocks=new Array(10).fill(0),clearSymbols(),-1!==lastActiveLedIndex){const t=ledNode(lastActiveLedIndex);t&&t.classList.remove("a11y-active"),lastActiveLedIndex=-1}stopBass()}async function runSublevel(t,e,n,i=!1){currentIsDifficultLevel=IsDifficultLevel(t);let s=0,o=0;const a=new Array(10).fill(0);for(currentLocks=a;!isFullyLocked(a,t);){if(creativeModeActive=shouldBeCreative(),creativeModeActive?startBass():stopBass(),creativeModeActive){const t=[[NOTES.E4,NOTES.G4,NOTES.C4],[NOTES.F4,NOTES.A4,NOTES.D4],[NOTES.G4,NOTES.B3,NOTES.E4],[NOTES.A4,NOTES.C4,NOTES.F4],[NOTES.B3,NOTES.D4,NOTES.G4],[NOTES.C4,NOTES.E4,NOTES.A4]],e=Math.floor(.8*n),i=10+Math.floor(15*Math.random());playChord(t[randInt(t.length)],e,0,i)}else 0===a[s]?playTone(NOTES.C3,Math.floor(.8*n)):2===a[s]?playTone(NOTES.G4,Math.floor(.8*n)):playTone(NOTES.E4,Math.floor(.8*n));0===a[s]?setPixel(s,_onColor):IsDifficultLevel(t)&&1===a[s]?setPixel(s,_midColor):setPixel(s,_onColor),setActiveHighlight(s),t%3>0&&(_offColor=PALETTE[randInt(PALETTE.length)]);const e=performance.now();let i=!1,l=!1,r=!1;for(;performance.now()-e<n;){if(abortFlag)return;if(i){await new Promise(t=>setTimeout(t,10));continue}const e=leftDown&&!l,n=rightDown&&!r;e&&s<5||n&&s>=5?(lockPixelIfEligible(s,a,t),i=!0):(e&&s>=5||n&&s<5)&&loseRandomLock(a),l=leftDown,r=rightDown,await new Promise(t=>setTimeout(t,10))}0===a[s]?setPixel(s,_offColor):IsDifficultLevel(t)&&1===a[s]?setPixel(s,_midColor):setPixel(s,_onColor),updateSymbolFor(s),0===s&&(o=1),9===s&&(o=-1),s+=o}if(i&&null==winElapsedMs){try{winElapsedMs=performance.now()-gameStartTs}catch{winElapsedMs=null}try{null!=winElapsedMs&&(isNewBestThisRun=recordIfBest(winElapsedMs,runDifficulty)||isNewBestThisRun)}catch{}cancelTimerLoop(),timerOverlay&&null!=winElapsedMs&&(timerOverlay.textContent=formatElapsed(winElapsedMs)+(isNewBestThisRun?" ★":""))}}function loseRandomLock(t){if(t.every(t=>0===t))return;let e=randInt(10);for(;0===t[e];)e=randInt(10);t[e]--,setPixel(e,1===t[e]?_midColor:_offColor),updateSymbolFor(e),playTone(262,250)}function lockPixelIfEligible(t,e,n){if(0===e[t]||IsDifficultLevel(n)&&1===e[t]){e[t]++,IsDifficultLevel(n)&&1===e[t]?setPixel(t,_midColor):setPixel(t,_onColor);try{const e=ledNode(t);e&&e.offsetHeight}catch{}updateSymbolFor(t)}}function isFullyLocked(t,e){return t.every(t=>IsDifficultLevel(e)?t>=2:t>=1)}async function StartGame(){if(isPlaying)return;stopWinAnimationLoop(),stopIdleAnimation(),isPlaying=!0,abortFlag=!1,winElapsedMs=null,isNewBestThisRun=!1,runDifficulty=difficultyMode,markActive(),await unlockNowFromGesture();await ensureAudio(!0)||showStatus("Tap Sound to enable audio on iOS"),playButtonWrap&&(playButtonWrap.style.display="none"),showStatus("Starting...");try{await PlayGame()}finally{if(isPlaying=!1,cancelTimerLoop(),hideTimerOverlay(),timerOverlay&&(timerOverlay.textContent=""),startBtn){if(null!=winElapsedMs){const t=formatElapsed(winElapsedMs),e=isNewBestThisRun?" ★":"";startBtn.innerHTML=`<div class="btn-time">${t}${e}</div><div class="btn-label">Restart</div>`}else startBtn.textContent="Restart";startBtn.setAttribute("aria-label","Restart")}playButtonWrap&&(playButtonWrap.style.display=""),null==winElapsedMs&&startIdleAnimation()}}if(startBtn){const t=async t=>{t.preventDefault(),unlockNowFromGesture(),ensureAudio(!0).catch(()=>{}),await StartGame()};startBtn.addEventListener("click",t),startBtn.addEventListener("pointerdown",e=>{e.preventDefault(),e.stopPropagation(),t(e)}),startBtn.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),t(e)},{passive:!1})}clearAll(_offColor),hideStatus(),currentLocks=new Array(10).fill(0),clearSymbols(),lastActiveLedIndex=-1,startIdleAnimation();