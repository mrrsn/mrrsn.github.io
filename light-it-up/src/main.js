const el=t=>document.querySelector(t),PALETTE=[[255,0,0],[0,0,255],[119,255,255],[255,52,86],[125,249,255],[255,128,0],[176,177,17],[218,94,17]];let _offColor=[0,0,255];const _midColor=[255,255,255],_onColor=[0,255,0],_goldColor=[255,215,0],_leds=10,CONFIG=window.CONFIG||{sublevels:0,levels:[]};function visibleLevels(){return(CONFIG?.levels||[]).filter(t=>!t.hidden)}function IsDifficultLevel(t){const e=CONFIG?.levels?.[t];return!(!e||!e.difficult)}const NOTES={C3:131,C4:262,C5:523,D4:294,E4:330,F4:349,G4:392,A4:440,B3:247,G5:784},helloMelody=[NOTES.C3,NOTES.C3,NOTES.G4,NOTES.C3,0,NOTES.C4,NOTES.C4,NOTES.B3,NOTES.C4];let ctx=null,audioUnlocked=!1;function createAudioContext(){const t=window.AudioContext||window.webkitAudioContext;if(!t)return null;try{return new t}catch{return null}}async function ensureAudio(t=!1){if(ctx||(ctx=createAudioContext()),!ctx)return!1;if("running"!==ctx.state)try{await ctx.resume()}catch{}if(t&&ctx&&"running"===ctx.state)try{const t=ctx.createOscillator(),e=ctx.createGain();e.gain.value=1e-4,t.connect(e),e.connect(ctx.destination),t.start(),t.stop(ctx.currentTime+.01)}catch{}return ctx&&"running"===ctx.state}function unlockNowFromGesture(){if(audioUnlocked)return!0;if(ctx||(ctx=createAudioContext()),!ctx)return!1;try{ctx.resume()}catch{}try{const t=ctx.createBuffer(1,1,22050),e=ctx.createBufferSource();e.buffer=t,e.connect(ctx.destination),e.start(0)}catch{}return audioUnlocked=ctx&&"running"===ctx.state||audioUnlocked,audioUnlocked}function unlockAudioOnFirstGesture(){if(audioUnlocked)return;const t=e=>{unlockNowFromGesture()&&["pointerdown","touchstart","touchend","mousedown","keydown"].forEach(e=>window.removeEventListener(e,t,!0))};["pointerdown","touchstart","touchend","mousedown","keydown"].forEach(e=>window.addEventListener(e,t,{capture:!0,passive:!1}))}async function playTone(t,e,n=0){if(!t)return new Promise(t=>setTimeout(t,e));if(isMuted)return new Promise(t=>setTimeout(t,e));if(!await ensureAudio(!1)||!ctx)return new Promise(t=>setTimeout(t,e));const o=ctx.createOscillator(),a=ctx.createGain();o.frequency.value=t,o.type="sine",o.connect(a),a.connect(ctx.destination);const s=Math.max(ctx.currentTime,ctx.currentTime+n),i=Math.max(.001,e/1e3),r=Math.min(.01,.2*i),l=Math.min(.02,.4*i);a.gain.setValueAtTime(0,s),a.gain.linearRampToValueAtTime(.08,s+r);const c=Math.max(s,s+i-l);return a.gain.setValueAtTime(.08,c),a.gain.linearRampToValueAtTime(1e-4,c+l),o.start(s),o.stop(c+l),o.onended=()=>{try{o.disconnect(),a.disconnect()}catch{}},new Promise(t=>setTimeout(t,e))}async function playChord(t,e,n=0,o=0){if(!Array.isArray(t)||0===t.length)return new Promise(t=>setTimeout(t,e));if(isMuted)return new Promise(t=>setTimeout(t,e));if(!await ensureAudio(!1)||!ctx)return new Promise(t=>setTimeout(t,e));const a=.08/Math.max(1,Math.min(t.length,4)),s=Math.max(ctx.currentTime,ctx.currentTime+n),i=t.slice(),r=Math.max(0,o)/1e3;r>0&&(i.sort((t,e)=>t-e),Math.random()<.5&&i.reverse());const l=Math.max(.001,e/1e3),c=Math.min(.01,.2*l),u=Math.min(.02,.4*l);i.forEach((t,e)=>{const n=ctx.createOscillator(),o=ctx.createGain();n.frequency.value=t,n.type="sine",n.connect(o),o.connect(ctx.destination);const i=s+r*e,d=i+l;o.gain.setValueAtTime(0,i),o.gain.linearRampToValueAtTime(a,i+c);const f=Math.max(i,d-u);o.gain.setValueAtTime(a,f),o.gain.linearRampToValueAtTime(1e-4,f+u),n.start(i),n.stop(f+u),n.onended=()=>{try{n.disconnect(),o.disconnect()}catch{}}});const d=e+Math.max(0,o)*(i.length-1);return new Promise(t=>setTimeout(t,d))}unlockAudioOnFirstGesture();let bassOsc=null,bassGain=null;async function startBass(){if(bassOsc||isMuted)return;if(!await ensureAudio(!1)||!ctx)return;const t=ctx.createOscillator(),e=ctx.createGain();t.type="sine",t.frequency.value=NOTES.C3,e.gain.value=0,t.connect(e),e.connect(ctx.destination);const n=ctx.currentTime;e.gain.setValueAtTime(0,n),e.gain.linearRampToValueAtTime(.05,n+.05);try{t.start(n)}catch{}bassOsc=t,bassGain=e}function stopBass(){if(!bassOsc||!bassGain||!ctx)return;const t=ctx.currentTime;try{bassGain.gain.cancelScheduledValues(t),bassGain.gain.setValueAtTime(bassGain.gain.value,t),bassGain.gain.linearRampToValueAtTime(1e-4,t+.06),bassOsc.stop(t+.07)}catch{}const e=bassOsc,n=bassGain;bassOsc=null,bassGain=null,e.onended=()=>{try{e.disconnect(),n.disconnect()}catch{}}}function randInt(t){return Math.floor(Math.random()*t)}function closestFromEventTarget(t,e){let n=t;for(;n&&1!==n.nodeType;)n=n.parentNode;return n&&n.closest?n.closest(e):null}const app=document.getElementById("app");app.innerHTML='\n  <div class="game">\n  <div class="scoreline"><div>Light It Up</div><div class="mute-container"><button id="muteBtn" class="mute-btn" aria-pressed="false" aria-label="Sound On">Sound: On</button><button id="a11yBtn" class="mute-btn" aria-pressed="false" aria-label="Accessibility Off">Accessibility: Off</button><button id="brutalBtn" class="mute-btn" aria-pressed="false" aria-label="Brutal Off">Brutal: Off</button></div></div>\n  <div class="instructions">Your only keys for play are Left and Right. Figure out how to make and keep all the lights Green.</div>\n    \n    <div id="iosAudioTip" class="ios-audio-tip" style="display:none">No sound? On iPhone, ensure the Silent switch is off and volume is up.</div>\n  <div class="leds" id="leds"><div id="playButtonWrap" class="center-button"><button id="startBtn" class="play-btn" aria-label="Start">Start</button></div></div>\n    <div class="controls">\n  <div class="row center"><div id="status"><span id="statusText"></span></div></div>\n    </div>\n  </div>\n';const ledsRoot=el("#leds"),startAngle=135,arc=270;for(let t=0;t<10;t++){const e=document.createElement("div");e.className="led",e.dataset.pos=t,e.textContent="";const n=(135+t/9*270)*(Math.PI/180),o=140,a=Math.cos(n)*o,s=Math.sin(n)*o;e.style.transform=`translate(calc(-50% + ${a}px), calc(-50% + ${s}px))`,ledsRoot.appendChild(e)}const status=el("#status"),statusText=document.getElementById("statusText"),iosAudioTip=el("#iosAudioTip"),muteBtn=el("#muteBtn"),a11yBtn=el("#a11yBtn"),brutalBtn=el("#brutalBtn"),startBtn=document.getElementById("startBtn"),playButtonWrap=document.getElementById("playButtonWrap"),hideInstructions=()=>document.querySelectorAll(".instructions").forEach(t=>t.classList.add("is-hidden")),hideIosTip=()=>{const t=document.getElementById("iosAudioTip");t&&t.classList.add("is-hidden")},hideStatus=()=>status.classList.add("is-hidden"),showStatus=t=>{status.classList.remove("is-hidden"),statusText&&(statusText.textContent=t)};let isPlaying=!1,isMuted=!1,isA11ySymbols=!1,isBrutal=!1,currentLocks=new Array(10).fill(0),lastActiveLedIndex=-1;function ledNode(t){return ledsRoot.querySelector(`[data-pos='${t}']`)}function updateSymbolFor(t){const e=ledNode(t);if(!e)return;if(!isA11ySymbols)return e.textContent="",void(e.style.color="");const n=currentLocks[t]||0;n>=2?(e.textContent="â˜…",e.style.color="#eaf2ff"):1===n?(e.textContent="+",e.style.color="#0a0a0a"):(e.textContent="",e.style.color="")}function refreshAccessibilitySymbols(){for(let t=0;t<10;t++)updateSymbolFor(t)}function clearSymbols(){for(let t=0;t<10;t++){const e=ledNode(t);e&&(e.textContent="",e.style.color="")}}function setActiveHighlight(t){if(-1!==lastActiveLedIndex){const t=ledNode(lastActiveLedIndex);t&&t.classList.remove("a11y-active")}if(lastActiveLedIndex=t,!isA11ySymbols)return;const e=ledNode(t);e&&e.classList.add("a11y-active")}let lastActiveAt=performance.now(),creativeModeActive=!1;const INACTIVITY_MS=5e3;function markActive(){lastActiveAt=performance.now(),creativeModeActive=!1}function shouldBeCreative(){return isPlaying&&!leftDown&&!rightDown&&performance.now()-lastActiveAt>=5e3}const isTouch="ontouchstart"in window||navigator.maxTouchPoints>0||window.matchMedia&&window.matchMedia("(pointer: coarse)").matches;if(isTouch){const t=document.querySelectorAll(".instructions");t[0]&&(t[0].textContent="You only need to touch the left or right half of the screen to play. Figure out how to make and keep all the lights Green."),t[1]&&t[1].remove()}try{const t=navigator.userAgent||"";(/iPad|iPhone|iPod/.test(t)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&iosAudioTip&&(iosAudioTip.style.display="block")}catch{}if(muteBtn){const t=()=>{isMuted?(muteBtn.textContent="Sound: Off",muteBtn.setAttribute("aria-pressed","true"),muteBtn.setAttribute("aria-label","Sound Off")):(muteBtn.textContent="Sound: On",muteBtn.setAttribute("aria-pressed","false"),muteBtn.setAttribute("aria-label","Sound On"))};t(),muteBtn.addEventListener("click",e=>{e.preventDefault(),unlockNowFromGesture(),markActive(),isMuted=!isMuted,isMuted&&stopBass(),t()}),muteBtn.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),unlockNowFromGesture(),markActive(),isMuted=!isMuted,isMuted&&stopBass(),t()},{passive:!1})}if(a11yBtn){const t=()=>{a11yBtn.textContent="Accessibility: "+(isA11ySymbols?"On":"Off"),a11yBtn.setAttribute("aria-pressed",isA11ySymbols?"true":"false"),a11yBtn.setAttribute("aria-label",isA11ySymbols?"Accessibility On":"Accessibility Off")};t();const e=()=>{isA11ySymbols=!isA11ySymbols,t(),refreshAccessibilitySymbols();const e=-1!==lastActiveLedIndex?ledNode(lastActiveLedIndex):null;e&&(isA11ySymbols?e.classList.add("a11y-active"):e.classList.remove("a11y-active"))};a11yBtn.addEventListener("click",t=>{t.preventDefault(),e()}),a11yBtn.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),e()},{passive:!1})}if(brutalBtn){const t=()=>{brutalBtn.textContent="Brutal: "+(isBrutal?"On":"Off"),brutalBtn.setAttribute("aria-pressed",isBrutal?"true":"false"),brutalBtn.setAttribute("aria-label",isBrutal?"Brutal On":"Brutal Off")};t();const e=()=>{isBrutal=!isBrutal,t()};brutalBtn.addEventListener("click",t=>{t.preventDefault(),e()}),brutalBtn.addEventListener("touchstart",t=>{t.preventDefault(),t.stopPropagation(),e()},{passive:!1})}let leftDown=!1,rightDown=!1;window.addEventListener("keydown",t=>{"ArrowLeft"===t.key&&(leftDown=!0),"ArrowRight"===t.key&&(rightDown=!0),"ArrowLeft"!==t.key&&"ArrowRight"!==t.key||markActive()}),window.addEventListener("keyup",t=>{"ArrowLeft"===t.key&&(leftDown=!1),"ArrowRight"===t.key&&(rightDown=!1)});let abortFlag=!1;function handleTouchSide(t){const e=t.clientX<(window.innerWidth||document.documentElement.clientWidth)/2;leftDown=!!e,rightDown=!e}if(window.addEventListener("keydown",t=>{"Escape"===t.key&&(abortFlag=!0,showStatus("Stopped"),t.preventDefault())}),isTouch){let t=0;window.addEventListener("touchend",e=>{const n=Date.now();n-t<300&&e.preventDefault(),t=n},{passive:!1}),window.addEventListener("touchstart",t=>{t.touches&&t.touches.length>1&&t.preventDefault()},{passive:!1}),window.addEventListener("touchmove",t=>{t.touches&&t.touches.length>1&&t.preventDefault()},{passive:!1}),window.addEventListener("touchstart",t=>{if(closestFromEventTarget(t.target,".mute-container")||closestFromEventTarget(t.target,"#muteBtn"))return;const e=t.changedTouches[0];e&&(handleTouchSide(e),markActive(),t.preventDefault())},{passive:!1}),window.addEventListener("touchmove",t=>{const e=t.changedTouches[0];e&&(handleTouchSide(e),markActive())},{passive:!0});const e=()=>{leftDown=!1,rightDown=!1};window.addEventListener("touchend",()=>{e(),markActive()}),window.addEventListener("touchcancel",()=>{e(),markActive()})}function setPixel(t,e){ledsRoot.querySelector(`[data-pos='${t}']`).style.background=`rgb(${e[0]},${e[1]},${e[2]})`}function clearAll(t){for(let e=0;e<10;e++)setPixel(e,t)}async function PlayMusic(t){for(const e of t)await playTone(e||0,120),await new Promise(t=>setTimeout(t,20))}async function PlayGame(){let t=0,e=!1;isTouch&&!e&&(t=0,e=!0,showStatus(`Level ${t+1}`),await new Promise(t=>setTimeout(t,250)),hideStatus()),e?(showStatus(`Level ${t+1}`),await new Promise(t=>setTimeout(t,350)),hideStatus()):showStatus("Select skill: Left = lower, Right = higher. Press both to confirm, or hit Tab.");const n=visibleLevels().length;let o,a=!1,s=!1;if(!e)for(o=t=>{"Tab"===t.key&&(a=!0,t.preventDefault())},window.addEventListener("keydown",o),s=!0;!(clearAll([10,10,10]),setPixel(t,[125,249,255]),await new Promise(t=>setTimeout(t,150)),leftDown&&rightDown||a||e);)if(rightDown&&t<n-1&&(t++,await new Promise(t=>setTimeout(t,200))),leftDown&&t>0&&(t--,await new Promise(t=>setTimeout(t,200))),abortFlag)return abortFlag=!1,showStatus("Stopped"),void(o&&window.removeEventListener("keydown",o));s&&o&&window.removeEventListener("keydown",o),await PlayMusic(helloMelody),hideInstructions(),hideIosTip(),await Countdown();for(let e=t;e<n;e++){if(showStatus(`Level ${e+1}`),abortFlag)return abortFlag=!1,void showStatus("Stopped");await runLevel(e)}for(let t=0;t<CONFIG.levels.length;t++)if(CONFIG.levels[t].hidden){if(showStatus(`Level ${t+1}`),abortFlag)return abortFlag=!1,void showStatus("Stopped");await runLevel(t)}await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),showStatus("You won!"),stopBass(),await WinAnimation(16,220)}async function WinAnimation(t=8,e=220){for(let n=0;n<t;n++){const t=n%2==1;for(let e=0;e<10;e++){const n=e%2==0;setPixel(e,(t?!n:n)?_onColor:_goldColor)}await new Promise(t=>setTimeout(t,e))}for(let t=0;t<10;t++)setPixel(t,t%2==0?_onColor:_goldColor)}async function Countdown(){const t=[[255,0,0],[255,255,0],[0,255,0]];for(const e of t)clearAll(e),await playTone(262,700),await new Promise(t=>setTimeout(t,300));clearAll(_offColor)}function scaledMs(t){return isBrutal?Math.max(1,Math.floor(t/2)):t}async function runLevel(t){const e=scaledMs(CONFIG.levels[t].baseMs),n=t>=CONFIG.levels.length-1,o=n?e:scaledMs(CONFIG.levels[t+1].baseMs),a=n?0:(o-e)/CONFIG.sublevels;let s=e;for(let e=0;e<CONFIG.sublevels;e++){if(abortFlag)return;await runSublevel(t,e,s),await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),resetBoardForNextSublevel(),s+=a}}function resetBoardForNextSublevel(){if(_offColor=PALETTE[randInt(PALETTE.length)],clearAll(_offColor),currentLocks=new Array(10).fill(0),clearSymbols(),-1!==lastActiveLedIndex){const t=ledNode(lastActiveLedIndex);t&&t.classList.remove("a11y-active"),lastActiveLedIndex=-1}stopBass()}async function runSublevel(t,e,n){let o=0,a=0;const s=new Array(10).fill(0);for(currentLocks=s;!isFullyLocked(s,t);){if(creativeModeActive=shouldBeCreative(),creativeModeActive?startBass():stopBass(),creativeModeActive){const t=[[NOTES.E4,NOTES.G4,NOTES.C4],[NOTES.F4,NOTES.A4,NOTES.D4],[NOTES.G4,NOTES.B3,NOTES.E4],[NOTES.A4,NOTES.C4,NOTES.F4],[NOTES.B3,NOTES.D4,NOTES.G4],[NOTES.C4,NOTES.E4,NOTES.A4]],e=Math.floor(.8*n),o=10+Math.floor(15*Math.random());playChord(t[randInt(t.length)],e,0,o)}else 0===s[o]?playTone(NOTES.C3,Math.floor(.8*n)):2===s[o]?playTone(NOTES.G4,Math.floor(.8*n)):playTone(NOTES.E4,Math.floor(.8*n));setPixel(o,_onColor),setActiveHighlight(o),t%3>0&&(_offColor=PALETTE[randInt(PALETTE.length)]);const e=performance.now();let i=!1,r=!1,l=!1;for(;performance.now()-e<n;){if(abortFlag)return;if(i){await new Promise(t=>setTimeout(t,10));continue}const e=leftDown&&!r,n=rightDown&&!l;e&&o<5||n&&o>=5?(lockPixelIfEligible(o,s,t),i=!0):(e&&o>=5||n&&o<5)&&loseRandomLock(s),r=leftDown,l=rightDown,await new Promise(t=>setTimeout(t,10))}0===s[o]?setPixel(o,_offColor):IsDifficultLevel(t)&&1===s[o]&&setPixel(o,_midColor),updateSymbolFor(o),0===o&&(a=1),9===o&&(a=-1),o+=a}}function loseRandomLock(t){if(t.every(t=>0===t))return;let e=randInt(10);for(;0===t[e];)e=randInt(10);t[e]--,setPixel(e,1===t[e]?_midColor:_offColor),updateSymbolFor(e),playTone(262,250)}function lockPixelIfEligible(t,e,n){(0===e[t]||IsDifficultLevel(n)&&1===e[t])&&(e[t]++,updateSymbolFor(t))}function isFullyLocked(t,e){return t.every(t=>IsDifficultLevel(e)?t>=2:t>=1)}async function StartGame(){if(!isPlaying){isPlaying=!0,abortFlag=!1,markActive(),await unlockNowFromGesture(),playButtonWrap&&(playButtonWrap.style.display="none"),showStatus("Starting...");try{await PlayGame()}finally{isPlaying=!1,startBtn&&(startBtn.textContent="Restart",startBtn.setAttribute("aria-label","Restart")),playButtonWrap&&(playButtonWrap.style.display="")}}}if(window.addEventListener("keydown",async t=>{"Tab"===t.key&&(t.preventDefault(),await StartGame())}),startBtn){const t=async t=>{t.preventDefault(),await StartGame()};startBtn.addEventListener("click",t),startBtn.addEventListener("pointerdown",e=>{e.preventDefault(),e.stopPropagation(),t(e)}),startBtn.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation(),t(e)},{passive:!1})}clearAll(_offColor),hideStatus(),currentLocks=new Array(10).fill(0),clearSymbols(),lastActiveLedIndex=-1;