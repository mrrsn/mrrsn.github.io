const el=t=>document.querySelector(t),PALETTE=[[255,0,0],[0,0,255],[119,255,255],[255,52,86],[125,249,255],[255,128,0],[176,177,17],[218,94,17]];let _offColor=[0,0,255];const _midColor=[255,255,255],_onColor=[0,255,0],_leds=10,_levels=10,_maxSkill=9,_skillWindow=[700,650,600,550,550,550,500,500,500],_speedUpPct=.09,NOTES={C3:131,C4:262,C5:523,E4:330,G4:392},helloMelody=[NOTES.C3,NOTES.C3,NOTES.G4,NOTES.C3,0,NOTES.C4,NOTES.C4,247,NOTES.C4],ctx=new(window.AudioContext||window.webkitAudioContext);function playTone(t,e,o=0){if(!t)return new Promise(t=>setTimeout(t,e));const n=ctx.createOscillator(),l=ctx.createGain();return n.frequency.value=t,n.type="sine",n.connect(l),l.connect(ctx.destination),l.gain.value=.08,n.start(ctx.currentTime+o),n.stop(ctx.currentTime+o+e/1e3),new Promise(t=>setTimeout(t,e))}function randInt(t){return Math.floor(Math.random()*t)}const app=document.getElementById("app");app.innerHTML='\n  <div class="game">\n    <div class="scoreline"><div>Light It Up</div></div>\n    <div class="leds" id="leds"></div>\n    <div class="controls">\n      <div class="row center"><div id="status"></div></div>\n      <div class="row center"><button id="start" class="big">Start</button><button id="stop" class="big">Stop</button></div>\n    </div>\n  </div>\n';const ledsRoot=el("#leds"),startAngle=135,arc=270;for(let t=0;t<10;t++){const e=document.createElement("div");e.className="led",e.dataset.pos=t,e.textContent="";const o=(135+t/9*270)*(Math.PI/180),n=140,l=Math.cos(o)*n,a=Math.sin(o)*n;e.style.transform=`translate(calc(-50% + ${l}px), calc(-50% + ${a}px))`,ledsRoot.appendChild(e)}const startBtn=el("#start"),status=el("#status");let leftDown=!1,rightDown=!1;window.addEventListener("keydown",t=>{"ArrowLeft"===t.key&&(leftDown=!0),"ArrowRight"===t.key&&(rightDown=!0)}),window.addEventListener("keyup",t=>{"ArrowLeft"===t.key&&(leftDown=!1),"ArrowRight"===t.key&&(rightDown=!1)});const stopBtn=el("#stop");let abortFlag=!1;function setPixel(t,e){ledsRoot.querySelector(`[data-pos='${t}']`).style.background=`rgb(${e[0]},${e[1]},${e[2]})`}function clearAll(t){for(let e=0;e<10;e++)setPixel(e,t)}async function PlayMusic(t){for(const e of t)await playTone(e||0,120),await new Promise(t=>setTimeout(t,20))}function IsDifficult(t){return t%3==2}async function PlayGame(){status.textContent="Select skill: Left = down, Right = up. Press both to confirm.";let t=0;for(;clearAll([10,10,10]),setPixel(t,[125,249,255]),await new Promise(t=>setTimeout(t,150)),!leftDown||!rightDown;)if(rightDown&&t<8&&(t++,await new Promise(t=>setTimeout(t,200))),leftDown&&t>0&&(t--,await new Promise(t=>setTimeout(t,200))),abortFlag)return abortFlag=!1,void(status.textContent="Stopped");await PlayMusic(helloMelody),status.textContent="Starting...",await Countdown();for(let e=t;e<9;e++){if(abortFlag)return abortFlag=!1,void(status.textContent="Stopped");await PlaySkill(e)}await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),status.textContent="You won!"}async function Countdown(){const t=[[255,0,0],[255,255,0],[0,255,0]];for(const e of t)clearAll(e),await playTone(262,700),await new Promise(t=>setTimeout(t,300));clearAll(_offColor)}async function PlaySkill(t){let e=_skillWindow[t];const o=Math.floor(.09*e);for(let n=0;n<10;n++){if(abortFlag)return;await PlayLevel(t,n,e),await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),InitForNextLevel(),e-=o}}function InitForNextLevel(){_offColor=PALETTE[randInt(PALETTE.length)],clearAll(_offColor)}async function PlayLevel(t,e,o){let n=0,l=0;const a=new Array(10).fill(0);for(;!IsFull(a,t);){0===a[n]?playTone(131,Math.floor(.8*o)):2===a[n]?playTone(523,Math.floor(.8*o)):playTone(262,Math.floor(.8*o)),setPixel(n,_onColor),t%3>0&&(_offColor=PALETTE[randInt(PALETTE.length)]);const e=performance.now();let i=!1;for(;performance.now()-e<o;){if(abortFlag)return;i||(leftDown&&!rightDown&&n<5||rightDown&&!leftDown&&n>=5?(GainThisOne(n,a,t),i=!0):(leftDown&&n>=5||rightDown&&n<5)&&LoseOne(a),await new Promise(t=>setTimeout(t,10)))}0===a[n]?setPixel(n,_offColor):IsDifficult(t)&&1===a[n]&&setPixel(n,_midColor),0===n&&(l=1),9===n&&(l=-1),n+=l}}function LoseOne(t){if(t.every(t=>0===t))return;let e=randInt(10);for(;0===t[e];)e=randInt(10);t[e]--,setPixel(e,1===t[e]?_midColor:_offColor),playTone(262,250)}function GainThisOne(t,e,o){(0===e[t]||IsDifficult(o)&&1===e[t])&&e[t]++}function IsFull(t,e){return t.every(t=>IsDifficult(e)?t>=2:t>=1)}stopBtn.addEventListener("click",()=>{abortFlag=!0,status.textContent="Stopped"}),startBtn.addEventListener("click",async()=>{if("suspended"===ctx.state)try{await ctx.resume()}catch(t){console.warn("AudioContext resume failed",t)}await PlayGame()}),clearAll(_offColor),status.textContent="Ready";