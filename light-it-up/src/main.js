const el=t=>document.querySelector(t),PALETTE=[[255,0,0],[0,0,255],[119,255,255],[255,52,86],[125,249,255],[255,128,0],[176,177,17],[218,94,17]];let _offColor=[0,0,255];const _midColor=[255,255,255],_onColor=[0,255,0],_leds=10,_levels=10,_maxSkill=10,_skillWindow=[700,650,600,550,550,550,500,500,500,500],_speedUpPct=.09,NOTES={C3:131,C4:262,C5:523,E4:330,G4:392},helloMelody=[NOTES.C3,NOTES.C3,NOTES.G4,NOTES.C3,0,NOTES.C4,NOTES.C4,247,NOTES.C4];let ctx=null,audioUnlocked=!1;function createAudioContext(){const t=window.AudioContext||window.webkitAudioContext;if(!t)return null;try{return new t}catch{return null}}async function ensureAudio(t=!1){if(ctx||(ctx=createAudioContext()),!ctx)return!1;if("running"!==ctx.state)try{await ctx.resume()}catch{}if(t&&ctx&&"running"===ctx.state)try{const t=ctx.createOscillator(),e=ctx.createGain();e.gain.value=1e-4,t.connect(e),e.connect(ctx.destination),t.start(),t.stop(ctx.currentTime+.01)}catch{}return ctx&&"running"===ctx.state}function unlockAudioOnFirstGesture(){if(audioUnlocked)return;const t=()=>{ensureAudio(!0).then(e=>{if(e){audioUnlocked=!0;const e=document.getElementById("sound-tip");e&&e.classList.add("is-hidden"),["touchstart","touchend","mousedown","keydown"].forEach(e=>window.removeEventListener(e,t,!0))}})};["touchstart","touchend","mousedown","keydown"].forEach(e=>window.addEventListener(e,t,!0))}async function playTone(t,e,n=0){if(!t)return new Promise(t=>setTimeout(t,e));if(!await ensureAudio(!1)||!ctx)return new Promise(t=>setTimeout(t,e));const o=ctx.createOscillator(),i=ctx.createGain();o.frequency.value=t,o.type="sine",o.connect(i),i.connect(ctx.destination),i.gain.value=.08;const s=Math.max(ctx.currentTime,ctx.currentTime+n);return o.start(s),o.stop(s+e/1e3),new Promise(t=>setTimeout(t,e))}function randInt(t){return Math.floor(Math.random()*t)}unlockAudioOnFirstGesture();const app=document.getElementById("app");app.innerHTML='\n  <div class="game">\n    <div class="scoreline"><div>Light It Up</div></div>\n  <div class="instructions">Your only keys for play are Left and Right. Figure out how to make and keep all the lights Green.</div>\n    <div class="instructions">Press Tab to Start. Press Esc to Stop at any time.</div>\n    <div id="sound-tip" class="sound-tip is-hidden">Tap to enable sound</div>\n    <div class="leds" id="leds"></div>\n    <div class="controls">\n      <div class="row center"><div id="status"></div></div>\n    </div>\n  </div>\n';const ledsRoot=el("#leds"),startAngle=135,arc=270;for(let t=0;t<10;t++){const e=document.createElement("div");e.className="led",e.dataset.pos=t,e.textContent="";const n=(135+t/9*270)*(Math.PI/180),o=140,i=Math.cos(n)*o,s=Math.sin(n)*o;e.style.transform=`translate(calc(-50% + ${i}px), calc(-50% + ${s}px))`,ledsRoot.appendChild(e)}const status=el("#status"),soundTip=el("#sound-tip"),hideInstructions=()=>document.querySelectorAll(".instructions").forEach(t=>t.classList.add("is-hidden")),hideStatus=()=>status.classList.add("is-hidden"),showStatus=t=>{status.classList.remove("is-hidden"),status.textContent=t};let isPlaying=!1,pendingSkill=null;const isTouch="ontouchstart"in window||navigator.maxTouchPoints>0;if(isTouch){const t=document.querySelectorAll(".instructions");t[0]&&(t[0].textContent="You only need to touch the left or right half of the screen to play. Figure out how to make and keep all the lights Green. Tap a dot to set level and start. Refresh the page to stop."),t[1]&&t[1].remove(),soundTip&&!audioUnlocked&&soundTip.classList.remove("is-hidden")}let leftDown=!1,rightDown=!1;window.addEventListener("keydown",t=>{"ArrowLeft"===t.key&&(leftDown=!0),"ArrowRight"===t.key&&(rightDown=!0)}),window.addEventListener("keyup",t=>{"ArrowLeft"===t.key&&(leftDown=!1),"ArrowRight"===t.key&&(rightDown=!1)});let abortFlag=!1;function handleTouchSide(t){const e=t.clientX<(window.innerWidth||document.documentElement.clientWidth)/2;leftDown=!!e,rightDown=!e}if(window.addEventListener("keydown",t=>{"Escape"===t.key&&(abortFlag=!0,showStatus("Stopped"),t.preventDefault())}),isTouch){let t=0;window.addEventListener("touchend",e=>{const n=Date.now();n-t<300&&e.preventDefault(),t=n},{passive:!1}),window.addEventListener("touchstart",t=>{t.touches&&t.touches.length>1&&t.preventDefault()},{passive:!1}),window.addEventListener("touchmove",t=>{t.touches&&t.touches.length>1&&t.preventDefault()},{passive:!1}),window.addEventListener("touchstart",t=>{if(t.target.closest(".led"))return;const e=t.changedTouches[0];e&&(handleTouchSide(e),t.preventDefault())},{passive:!1}),window.addEventListener("touchmove",t=>{const e=t.changedTouches[0];e&&handleTouchSide(e)},{passive:!0});const e=()=>{leftDown=!1,rightDown=!1};window.addEventListener("touchend",e),window.addEventListener("touchcancel",e);const n=async t=>{const e=t.target.closest(".led");if(!e)return;if(isPlaying)return;const n=parseInt(e.dataset.pos,10);Number.isNaN(n)||(pendingSkill=n,t.preventDefault(),t.stopPropagation(),await StartGame())};ledsRoot.addEventListener("click",n,{capture:!0}),ledsRoot.addEventListener("touchstart",n,{capture:!0,passive:!1})}function setPixel(t,e){ledsRoot.querySelector(`[data-pos='${t}']`).style.background=`rgb(${e[0]},${e[1]},${e[2]})`}function clearAll(t){for(let e=0;e<10;e++)setPixel(e,t)}async function PlayMusic(t){for(const e of t)await playTone(e||0,120),await new Promise(t=>setTimeout(t,20))}function IsDifficult(t){return t%3==2}async function PlayGame(){let t=0,e=!1;null!=pendingSkill&&(t=pendingSkill,e=!0,pendingSkill=null),e?(showStatus(`Level ${t+1}`),await new Promise(t=>setTimeout(t,350)),hideStatus()):showStatus("Select skill: Left = lower, Right = higher. Press both to confirm, or hit Tab.");let n,o,i=!1,s=!1;if(!e)for(n=t=>{"Tab"===t.key&&(i=!0,t.preventDefault())},window.addEventListener("keydown",n),o=n=>{const o=n.target.closest(".led");if(!o)return;const i=parseInt(o.dataset.pos,10);Number.isNaN(i)||(t=i,e=!0,n.preventDefault(),n.stopPropagation())},isTouch&&(ledsRoot.addEventListener("click",o,{capture:!0}),ledsRoot.addEventListener("touchstart",o,{capture:!0,passive:!1})),s=!0;!(clearAll([10,10,10]),setPixel(t,[125,249,255]),await new Promise(t=>setTimeout(t,150)),leftDown&&rightDown||i||e);)if(rightDown&&t<9&&(t++,await new Promise(t=>setTimeout(t,200))),leftDown&&t>0&&(t--,await new Promise(t=>setTimeout(t,200))),abortFlag)return abortFlag=!1,showStatus("Stopped"),n&&window.removeEventListener("keydown",n),void(isTouch&&o&&(ledsRoot.removeEventListener("click",o,{capture:!0}),ledsRoot.removeEventListener("touchstart",o,{capture:!0})));s&&(n&&window.removeEventListener("keydown",n),isTouch&&o&&(ledsRoot.removeEventListener("click",o,{capture:!0}),ledsRoot.removeEventListener("touchstart",o,{capture:!0}))),await PlayMusic(helloMelody),showStatus("Starting..."),hideInstructions(),await Countdown(),isTouch?setTimeout(()=>{hideStatus()},2e3):hideStatus();for(let e=t;e<10;e++){if(abortFlag)return abortFlag=!1,void showStatus("Stopped");await PlaySkill(e)}await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),showStatus("You won!")}async function Countdown(){const t=[[255,0,0],[255,255,0],[0,255,0]];for(const e of t)clearAll(e),await playTone(262,700),await new Promise(t=>setTimeout(t,300));clearAll(_offColor)}async function PlaySkill(t){let e=_skillWindow[t];const n=Math.floor(.09*e);for(let o=0;o<10;o++){if(abortFlag)return;await PlayLevel(t,o,e),await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),InitForNextLevel(),e-=n}}function InitForNextLevel(){_offColor=PALETTE[randInt(PALETTE.length)],clearAll(_offColor)}async function PlayLevel(t,e,n){let o=0,i=0;const s=new Array(10).fill(0);for(;!IsFull(s,t);){0===s[o]?playTone(131,Math.floor(.8*n)):2===s[o]?playTone(523,Math.floor(.8*n)):playTone(262,Math.floor(.8*n)),setPixel(o,_onColor),t%3>0&&(_offColor=PALETTE[randInt(PALETTE.length)]);const e=performance.now();let a=!1;for(;performance.now()-e<n;){if(abortFlag)return;a||(leftDown&&!rightDown&&o<5||rightDown&&!leftDown&&o>=5?(GainThisOne(o,s,t),a=!0):(leftDown&&o>=5||rightDown&&o<5)&&LoseOne(s),await new Promise(t=>setTimeout(t,10)))}0===s[o]?setPixel(o,_offColor):IsDifficult(t)&&1===s[o]&&setPixel(o,_midColor),0===o&&(i=1),9===o&&(i=-1),o+=i}}function LoseOne(t){if(t.every(t=>0===t))return;let e=randInt(10);for(;0===t[e];)e=randInt(10);t[e]--,setPixel(e,1===t[e]?_midColor:_offColor),playTone(262,250)}function GainThisOne(t,e,n){(0===e[t]||IsDifficult(n)&&1===e[t])&&e[t]++}function IsFull(t,e){return t.every(t=>IsDifficult(e)?t>=2:t>=1)}async function StartGame(){if(!isPlaying){isPlaying=!0,await ensureAudio(!0);try{await PlayGame()}finally{isPlaying=!1}}}window.addEventListener("keydown",async t=>{"Tab"===t.key&&(t.preventDefault(),await StartGame())}),clearAll(_offColor),showStatus("Ready");