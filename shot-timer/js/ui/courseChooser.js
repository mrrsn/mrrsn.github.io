import{setUiTotalSecondsUI,setUiExpectedShotsUI}from"./controls.js";import{getShotLog,exportShotsCsv,archiveStageShots,exportParticipantCsv,clearParticipantShots,resetTimer,setStageContext,getStageAttemptLabel}from"../timer/core.js";import{showStatus}from"./status.js";let courses=[];function appendMultilineAsParagraphs(e,t){if(!e)return;String(t||"").split("\n").forEach(t=>{const n=document.createElement("p");n.textContent=t,e.appendChild(n)})}function isSafeHttpUrl(e){if(!e||"string"!=typeof e)return!1;try{const t=new URL(e,location.href);return"http:"===t.protocol||"https:"===t.protocol}catch(e){return!1}}function renderCourseCredits(e,t,n={}){if(!t)return;const o=t.querySelector(".course-credits");if(o&&o.remove(),!e||!Array.isArray(e.credits)||0===e.credits.length)return;const s=document.createElement("div");s.className="course-credits","stage"===n.mode&&s.classList.add("course-credits-stage");const r=document.createElement("div");r.className="course-credits-heading",r.textContent="Credits",s.appendChild(r),e.credits.forEach(e=>{const t=document.createElement("div");if(t.className="course-credit-item",e.text)t.textContent=e.text;else{const o=e.name||"",r=e.year||"";function n(t){if(e.url&&o&&isSafeHttpUrl(e.url)){const n=document.createElement("a");n.href=e.url,n.target="_blank",n.rel="noopener noreferrer nofollow",n.textContent=o,n.className="course-credit-link",t.appendChild(n)}else o&&t.appendChild(document.createTextNode(o))}if(e.role){String(e.role).toLowerCase().includes("course")?(t.appendChild(document.createTextNode(`${e.role} `)),n(t),r&&t.appendChild(document.createTextNode(`, © ${r}`))):(t.appendChild(document.createTextNode(`${e.role} `)),n(t),r&&t.appendChild(document.createTextNode(`, ${r}`)))}else o&&(n(t),r&&t.appendChild(document.createTextNode(`, © ${r}`)))}s.appendChild(t)}),t.appendChild(s)}export async function initCourseChooser(){console.debug("initCourseChooser: start");try{console.debug("initCourseChooser: about to fetch course JSON");const e=new AbortController,t=setTimeout(()=>e.abort(),5e3);let n;try{n=await fetch("./data/courses/fbi-pistol-qualification.json",{signal:e.signal})}finally{clearTimeout(t)}if(!n||!n.ok)throw new Error("Could not fetch course JSON");const o=await n.json();courses=[o],console.debug("initCourseChooser: fetched and parsed course JSON",o&&o.id?o.id:"(no id)")}catch(e){console.warn("courseChooser: failed to load courses:",e);try{showStatus("Failed to load course data. Check that ./data/courses is accessible.","error")}catch(e){}return}const e=document.getElementById("courseSelect"),t=document.getElementById("stageSelect");if(!e||!t)return;function n(e,t){setUiTotalSecondsUI(t.timeSec),setUiExpectedShotsUI(t.shots);try{setStageContext({courseId:e.id,courseName:e.name,stageId:t.id,courseCredits:e.credits||null})}catch(e){}const n=document.getElementById("stageTitle"),o=document.getElementById("stageMeta"),s=document.getElementById("stageDetails");if(n&&(n.textContent=`Stage ${t.id}`),o){const e=void 0!==t.distanceYards?t.distanceYards:t.distance||null;let n="";if(null!=e&&""!==e){const t=Number(e);n=Number.isNaN(t)?String(e):`${t} yard${1===t?"":"s"}`}o.textContent=n}const r=document.getElementById("stageRounds");if(r){const e=null!=t.shots?t.shots:"",n=null!=t.timeSec?t.timeSec:"",o=t.startPosition||t.start||"";let s="";e&&n?s=`${e} round${1===e?"":"s"} in ${n} second${1===n?"":"s"}`:e?s=`${e} round${1===e?"":"s"}`:n&&(s=`${n} second${1===n?"":"s"}`),s&&o&&(s=`${s} from ${o}`),r.textContent=s}s&&(s.innerHTML="",t.notes&&appendMultilineAsParagraphs(s,t.notes));const a=document.getElementById("nextStageBtn");a&&(a.textContent="Next")}function o(e){const t=document.getElementById("stageTitle"),n=document.getElementById("stageMeta"),o=document.getElementById("stageRounds"),s=document.getElementById("stageDetails");if(t&&(t.textContent=e&&e.name?`${e.name} Scoring Instructions`:"Scoring Instructions"),n&&(n.textContent=""),o&&(o.textContent=""),s){s.innerHTML="";try{const t=[];Array.isArray(e.scoreRules)&&e.scoreRules.forEach(e=>{e&&t.push(String(e))});const n=e.roundCount||"",o=e.totalTimeSec||"";if(""!==n&&appendMultilineAsParagraphs(s,`Total shots: ${n}`),""!==o&&appendMultilineAsParagraphs(s,`Total time: ${o}s`),e.target&&appendMultilineAsParagraphs(s,`Target: ${e.target}`),t.forEach(e=>appendMultilineAsParagraphs(s,e)),e.notes){const t=document.createElement("div");t.className="course-instructions",appendMultilineAsParagraphs(t,e.notes),s.appendChild(t)}try{renderCourseCredits(e,s,{mode:"stage"})}catch(e){}}catch(e){}}const r=document.getElementById("nextStageBtn");r&&(r.textContent="Next")}function s(s){const r=s&&s.currentTarget?s.currentTarget:document.getElementById("nextStageBtn"),a=e.value,c=courses.find(e=>e.id===a);if(!c||!c.stages||0===c.stages.length)return;if(r&&"Save"===r.textContent){try{archiveStageShots({courseId:c.id,courseName:c.name,stageId:getStageAttemptLabel({courseId:c.id,stageId:Number(t.value)||null})||null})}catch(e){console.warn("archiveStageShots failed during Save",e)}const e=prompt("Enter filename (without extension) for participant CSV export","participant-results");if(!e)return;try{const t=exportParticipantCsv(),n=new Blob([t],{type:"text/csv"}),o=URL.createObjectURL(n),s=document.createElement("a");s.href=o,s.download=`${e}.csv`,document.body.appendChild(s),s.click(),s.remove(),URL.revokeObjectURL(o)}catch(e){console.error("Failed to export participant CSV",e),alert("Export failed: "+String(e))}return}const i=t.value;if("scoring"===i){if(c.stages&&c.stages.length>0){const e=c.stages[0];t.value=String(e.id);try{t.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){}n(c,e)}return}const d=Number(i)||0,l=c.stages.findIndex(e=>e.id===d);if(l===c.stages.length-1){try{archiveStageShots({courseId:c.id,courseName:c.name,stageId:getStageAttemptLabel({courseId:c.id,stageId:Number(t.value)||null})||null})}catch(e){console.warn("archiveStageShots failed",e)}try{resetTimer()}catch(e){console.warn("resetTimer failed",e)}t.value="scoring";try{t.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){}o(c);const e=document.getElementById("nextStageBtn");return void(e&&(e.textContent="Save"))}const u=(l+1)%c.stages.length,g=c.stages[u];try{archiveStageShots({courseId:c.id,courseName:c.name,stageId:getStageAttemptLabel({courseId:c.id,stageId:Number(t.value)||null})||null})}catch(e){console.warn("archiveStageShots failed",e)}try{resetTimer()}catch(e){console.warn("resetTimer failed",e)}t.value=String(g.id);try{t.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){}n(c,g)}function r(e){if(e){try{e.textContent&&e.textContent.trim()||(e.textContent="Next")}catch(e){}try{e.removeEventListener("click",s)}catch(e){}if(e.addEventListener("click",s),"undefined"!=typeof MutationObserver){new MutationObserver(()=>{try{if("Save"===(e.textContent||"").trim())try{setStartStopEnabled(!1,!1)}catch(e){}}catch(e){}}).observe(e,{characterData:!0,childList:!0,subtree:!0})}}}courses.forEach(t=>{const n=document.createElement("option");n.value=t.id,n.textContent=t.name,e.appendChild(n)}),e.addEventListener("change",()=>{console.debug("courseSelect: change ->",e.value);const n=e.value,s=courses.find(e=>e.id===n);t.innerHTML='<option value="">(select a stage)</option>';const r=document.getElementById("courseNotes");if(!s){r&&(r.textContent="Select a course to see course notes.");try{const e=document.getElementById("stageTitle");e&&(e.textContent="No stage selected");const t=document.getElementById("stageMeta");t&&(t.textContent="");const n=document.getElementById("stageRounds");n&&(n.textContent="");const o=document.getElementById("stageDetails");o&&(o.textContent="Select a course to see instructions here.")}catch(e){}return}const a=document.createElement("option");a.value="scoring",a.textContent="Scoring Instructions",t.appendChild(a),s.stages.forEach(e=>{const n=document.createElement("option");n.value=String(e.id),n.textContent=`Stage ${e.id}: ${e.shots} shots, ${e.timeSec}s`,t.appendChild(n)}),t.value="scoring";try{t.dispatchEvent(new Event("change",{bubbles:!0}))}catch(e){}o(s)}),t.addEventListener("change",()=>{console.debug("stageSelect: change ->",t.value);const s=e.value,r=t.value,a=courses.find(e=>e.id===s);if(!a)return;if("scoring"===r)return void o(a);const c=Number(r),i=a.stages.find(e=>e.id===c);i&&n(a,i)});const a=document.getElementById("nextStageBtn");if(a)r(a);else if("undefined"!=typeof MutationObserver){const e=new MutationObserver((e,t)=>{const n=document.getElementById("nextStageBtn");n&&(r(n),t.disconnect())});try{e.observe(document.body||document.documentElement,{childList:!0,subtree:!0})}catch(e){}}else{const e=setInterval(()=>{const t=document.getElementById("nextStageBtn");t&&(clearInterval(e),r(t))},250);setTimeout(()=>clearInterval(e),5e3)}document.addEventListener("stageFinished",n=>{const s=e.value,r=courses.find(e=>e.id===s);if(!r)return;const a=Number(t.value)||0;if(r.stages.findIndex(e=>e.id===a)===r.stages.length-1){const e=document.getElementById("nextStageBtn");e&&(e.textContent="Save");try{document.getElementById("stageDetails")&&r&&o(r)}catch(e){}}})}