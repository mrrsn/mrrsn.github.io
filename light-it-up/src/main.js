const el=t=>document.querySelector(t),PALETTE=[[255,0,0],[0,0,255],[119,255,255],[255,52,86],[125,249,255],[255,128,0],[176,177,17],[218,94,17]];let _offColor=[0,0,255];const _midColor=[255,255,255],_onColor=[0,255,0],_leds=10,_levels=10,_maxSkill=10,_skillWindow=[700,650,600,550,550,550,500,500,500,500],_speedUpPct=.09,NOTES={C3:131,C4:262,C5:523,E4:330,G4:392},helloMelody=[NOTES.C3,NOTES.C3,NOTES.G4,NOTES.C3,0,NOTES.C4,NOTES.C4,247,NOTES.C4],ctx=new(window.AudioContext||window.webkitAudioContext);function playTone(t,e,o=0){if(!t)return new Promise(t=>setTimeout(t,e));const n=ctx.createOscillator(),i=ctx.createGain();return n.frequency.value=t,n.type="sine",n.connect(i),i.connect(ctx.destination),i.gain.value=.08,n.start(ctx.currentTime+o),n.stop(ctx.currentTime+o+e/1e3),new Promise(t=>setTimeout(t,e))}function randInt(t){return Math.floor(Math.random()*t)}const app=document.getElementById("app");app.innerHTML='\n  <div class="game">\n    <div class="scoreline"><div>Light It Up</div></div>\n  <div class="instructions">Your only keys for play are Left and Right. Figure out how to make and keep all the lights Green.</div>\n    <div class="instructions">Press Tab to Start. Press Esc to Stop at any time.</div>\n    <div class="leds" id="leds"></div>\n    <div class="controls">\n      <div class="row center"><div id="status"></div></div>\n    </div>\n  </div>\n';const ledsRoot=el("#leds"),startAngle=135,arc=270;for(let t=0;t<10;t++){const e=document.createElement("div");e.className="led",e.dataset.pos=t,e.textContent="";const o=(135+t/9*270)*(Math.PI/180),n=140,i=Math.cos(o)*n,a=Math.sin(o)*n;e.style.transform=`translate(calc(-50% + ${i}px), calc(-50% + ${a}px))`,ledsRoot.appendChild(e)}const status=el("#status"),hideInstructions=()=>document.querySelectorAll(".instructions").forEach(t=>t.classList.add("is-hidden")),isTouch="ontouchstart"in window||navigator.maxTouchPoints>0;if(isTouch){const t=document.querySelectorAll(".instructions");t[0]&&(t[0].textContent="You only need to touch the left or right half of the screen to play. Figure out how to make and keep all the lights Green. Tap a dot to set level and start. Refresh the page to stop."),t[1]&&t[1].remove()}let leftDown=!1,rightDown=!1;window.addEventListener("keydown",t=>{"ArrowLeft"===t.key&&(leftDown=!0),"ArrowRight"===t.key&&(rightDown=!0)}),window.addEventListener("keyup",t=>{"ArrowLeft"===t.key&&(leftDown=!1),"ArrowRight"===t.key&&(rightDown=!1)});let abortFlag=!1;function handleTouchSide(t){const e=t.clientX<(window.innerWidth||document.documentElement.clientWidth)/2;leftDown=!!e,rightDown=!e}if(window.addEventListener("keydown",t=>{"Escape"===t.key&&(abortFlag=!0,status.textContent="Stopped",t.preventDefault())}),isTouch){window.addEventListener("touchstart",t=>{if(t.target.closest(".led"))return;const e=t.changedTouches[0];e&&(handleTouchSide(e),t.preventDefault())},{passive:!1}),window.addEventListener("touchmove",t=>{const e=t.changedTouches[0];e&&handleTouchSide(e)},{passive:!0});const t=()=>{leftDown=!1,rightDown=!1};window.addEventListener("touchend",t),window.addEventListener("touchcancel",t)}function setPixel(t,e){ledsRoot.querySelector(`[data-pos='${t}']`).style.background=`rgb(${e[0]},${e[1]},${e[2]})`}function clearAll(t){for(let e=0;e<10;e++)setPixel(e,t)}async function PlayMusic(t){for(const e of t)await playTone(e||0,120),await new Promise(t=>setTimeout(t,20))}function IsDifficult(t){return t%3==2}async function PlayGame(){status.textContent="Select skill: Left = lower, Right = higher. Press both to confirm, or hit Tab.";let t=0,e=!1;const o=t=>{"Tab"===t.key&&(e=!0,t.preventDefault())};window.addEventListener("keydown",o);let n=!1;const i=e=>{const o=e.target.closest(".led");if(!o)return;const i=parseInt(o.dataset.pos,10);Number.isNaN(i)||(t=i,n=!0,e.preventDefault(),e.stopPropagation())};for(isTouch&&(ledsRoot.addEventListener("click",i,{capture:!0}),ledsRoot.addEventListener("touchstart",i,{capture:!0,passive:!1}));!(clearAll([10,10,10]),setPixel(t,[125,249,255]),await new Promise(t=>setTimeout(t,150)),leftDown&&rightDown||e||n);)if(rightDown&&t<9&&(t++,await new Promise(t=>setTimeout(t,200))),leftDown&&t>0&&(t--,await new Promise(t=>setTimeout(t,200))),abortFlag)return abortFlag=!1,status.textContent="Stopped",window.removeEventListener("keydown",o),void(isTouch&&(ledsRoot.removeEventListener("click",i,{capture:!0}),ledsRoot.removeEventListener("touchstart",i,{capture:!0})));window.removeEventListener("keydown",o),isTouch&&(ledsRoot.removeEventListener("click",i,{capture:!0}),ledsRoot.removeEventListener("touchstart",i,{capture:!0})),await PlayMusic(helloMelody),status.textContent="Starting...",hideInstructions(),await Countdown(),status.textContent="";for(let e=t;e<10;e++){if(abortFlag)return abortFlag=!1,void(status.textContent="Stopped");await PlaySkill(e)}await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),status.textContent="You won!"}async function Countdown(){const t=[[255,0,0],[255,255,0],[0,255,0]];for(const e of t)clearAll(e),await playTone(262,700),await new Promise(t=>setTimeout(t,300));clearAll(_offColor)}async function PlaySkill(t){let e=_skillWindow[t];const o=Math.floor(.09*e);for(let n=0;n<10;n++){if(abortFlag)return;await PlayLevel(t,n,e),await PlayMusic([NOTES.C4,NOTES.E4,NOTES.G4,NOTES.C5]),InitForNextLevel(),e-=o}}function InitForNextLevel(){_offColor=PALETTE[randInt(PALETTE.length)],clearAll(_offColor)}async function PlayLevel(t,e,o){let n=0,i=0;const a=new Array(10).fill(0);for(;!IsFull(a,t);){0===a[n]?playTone(131,Math.floor(.8*o)):2===a[n]?playTone(523,Math.floor(.8*o)):playTone(262,Math.floor(.8*o)),setPixel(n,_onColor),t%3>0&&(_offColor=PALETTE[randInt(PALETTE.length)]);const e=performance.now();let s=!1;for(;performance.now()-e<o;){if(abortFlag)return;s||(leftDown&&!rightDown&&n<5||rightDown&&!leftDown&&n>=5?(GainThisOne(n,a,t),s=!0):(leftDown&&n>=5||rightDown&&n<5)&&LoseOne(a),await new Promise(t=>setTimeout(t,10)))}0===a[n]?setPixel(n,_offColor):IsDifficult(t)&&1===a[n]&&setPixel(n,_midColor),0===n&&(i=1),9===n&&(i=-1),n+=i}}function LoseOne(t){if(t.every(t=>0===t))return;let e=randInt(10);for(;0===t[e];)e=randInt(10);t[e]--,setPixel(e,1===t[e]?_midColor:_offColor),playTone(262,250)}function GainThisOne(t,e,o){(0===e[t]||IsDifficult(o)&&1===e[t])&&e[t]++}function IsFull(t,e){return t.every(t=>IsDifficult(e)?t>=2:t>=1)}let isPlaying=!1;async function StartGame(){if(!isPlaying){if(isPlaying=!0,"suspended"===ctx.state)try{await ctx.resume()}catch(t){console.warn("AudioContext resume failed",t)}try{await PlayGame()}finally{isPlaying=!1}}}window.addEventListener("keydown",async t=>{"Tab"===t.key&&(t.preventDefault(),await StartGame())}),clearAll(_offColor),status.textContent="Ready";